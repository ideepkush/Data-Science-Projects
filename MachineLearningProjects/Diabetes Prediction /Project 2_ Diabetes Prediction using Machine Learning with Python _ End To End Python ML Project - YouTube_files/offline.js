(function(g){var window=this;'use strict';var hXM=function(f){const e=new g.qi("und",new g.xG("Default","und",!0));e.captionTracks=f.captionTracks;return e},g6B=function(f){return new g.u5(function(e,B){let n=f.length;
const r=[];if(n){var L=function(H,k){n--;r[H]=k;n==0&&e(r)},d=function(H){B(H)};
for(let H=0;H<f.length;H++){var t=f[H];g.EY(t,g.l0(L,H),d)}}else e(r)})},Ko=function(f){return g.Wo((0,g.oSm)(),f)},SjB=function({type:f,
payload:e}){f={type:f};e!==void 0&&(f.payload=e);return f},qt=function(f){f=f.key||f.id;
if(!f)throw Error("Entity key is missing");return f},E6u=function(){if(zQ)return zQ();
zQ=g.BL("PersistentEntityStoreDb",{lf:{EntityStore:{sT:1},EntityAssociationStore:{sT:2}},shared:!1,upgrade(f,e){e(1)&&g.Tq(g.EU(f,"EntityStore",{keyPath:"key"}),"entityType","entityType");e(2)&&(f=g.EU(f,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.Tq(f,"byParentEntityKey","parentEntityKey"),g.Tq(f,"byChildEntityKey","childEntityKey"))},version:3});return zQ()},QWI=function(f){return g.Wo(E6u(),f)},T8G=function(f){return f instanceof Error?new a9("UNKNOWN_ENCODE_ERROR",
{originalMessage:f.message}):new a9("UNKNOWN_ENCODE_ERROR")},DZx=function(f){return f instanceof Error?new a9("UNKNOWN_DECODE_ERROR",{originalMessage:f.message}):new a9("UNKNOWN_DECODE_ERROR")},J5L=function(f,e){f=f instanceof a9?f:e(f);
g.J(f);throw f;},M2e=function(f,e,B){try{return f.J(e,B)}catch(n){J5L(n,T8G)}},po=function(f){f=(new TextEncoder).encode(f).subarray(0,16);
const e=new Uint8Array(16);e.set(f);return e},xZg=function(f){const e=GdB[f];
if(e)return e;g.Yv(new g.Dj("Entity model not found.",{entityType:f}))},Yo=function(f,e){a:{f=c3(f.G,e.version);
try{var B=f.G(e.data,e.key);break a}catch(n){J5L(n,DZx)}B=void 0}return B},Ax=function(f,e,B){return f.C.objectStore("EntityStore").get(e).then(n=>{if(n){if(B&&n.entityType!==B)throw Error("Incorrect entity type");
return Yo(f,n)}})},jn=function(f,e,B){return B?(B=B.map(n=>Ax(f,n,e)),g.FD.all(B)):f.C.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(e)).then(n=>n.map(r=>Yo(f,r)))},sWL=function(f,e,B){const n=qt(e);
return OJ(f,n).then(()=>WlF(f,e,B))},o9=function(f,e,B){let n=f.J[B];
n||(n=new Set,f.J[B]=n);n.add(e)},Vi=function(f,e,B){const n=qt(e),r=c3(f.G,1),L={...e};
return f.C.objectStore("EntityStore").get(n).then(d=>{if(d){if(d.entityType!==B)throw Error("Incorrect entity type");L.entityMetadata||(d=Yo(f,d),L.entityMetadata=d.entityMetadata)}}).then(()=>{const d={key:n,
entityType:B,data:M2e(r,L,n),version:1};return g.FD.all([f.C.objectStore("EntityStore").put(d),sWL(f,L,B)])}).then(()=>{o9(f,n,B);
return n})},l3=function(f,e,B){e=e.map(n=>Vi(f,n,B));
return g.FD.all(e)},y5F=function(f,e,B){if(B.has(e))return g.FD.resolve(void 0);
B.add(e);return Xnx(f,e).then(n=>f.C.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(e)).then(()=>n)).then(n=>{let r=g.FD.resolve(void 0);
for(const L of n)r=r.then(()=>y5F(f,L,B));
return r}).then(()=>{})},u3=function(f,e,B){if(B?.sX){const r=new Set;
return y5F(f,e,r).then(()=>{const L=[];for(const d of r)L.push(u3(f,d));return g.FD.all(L).then(()=>{})})}const n=g.aJ(e).entityType;
return g.FD.all([f.C.objectStore("EntityStore").delete(e),OJ(f,e)]).then(()=>{o9(f,e,n)})},OJ=function(f,e){return f.C.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(e))},FE=function(f,e){return g.Gq(f.C.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(e)},B=>g.FD.all([B.delete(),
OJ(f,B.cursor.primaryKey)]).then(()=>{o9(f,B.cursor.primaryKey,e);return g.MM(B)}))},PEF=function(f,e,B,n){const r=c3(f.G,1);
return Ax(f,e,n).then(L=>{if(L){L=g.$t(L,B);var d={key:e,entityType:n,data:M2e(r,L,e),version:1};return g.FD.all([f.C.objectStore("EntityStore").put(d),sWL(f,L,n)])}}).then(()=>{o9(f,e,n);
return e})},WlF=function(f,e,B){const n=qt(e);
B=xZg(B);if(!B)return g.FD.resolve([]);e=new B(e);f=f.C.objectStore("EntityAssociationStore");B=[];for(const r of e.G())B.push(f.put({parentEntityKey:n,childEntityKey:r}));return g.FD.all(B).then(r=>r.map(L=>L[1]))},Xnx=function(f,e){const B=f.C.objectStore("EntityAssociationStore");
return B.index("byParentEntityKey").getAll(IDBKeyRange.only(e)).then(n=>{const r=[];for(const L of n)r.push(B.index("byChildEntityKey").getAll(L.childEntityKey));return g.FD.all(r)}).then(n=>{const r=[];
for(const L of n)L.length===1&&r.push(L[0].childEntityKey);return r})},c3=function(f,e=0){f=f.C[e];
if(!f)throw e=new a9("INVALID_ENCODER_VERSION",{hT:e}),g.J(e),e;return f},Ixe=function(f,e){for(const B of f.observers)B(e)},mp=async function(f,e,B){var n=await QWI(f.token);
let r;e=await g.SY(n,["EntityStore","EntityAssociationStore"],e,L=>{r=new $ZI(L,f.C);return B(r)});
r&&(n=r.J,Object.keys(n).length>0&&(f.channel.postMessage(n),Ixe(f,n)));return e},UJ=function(f,e,B){return mp(f,{mode:"readwrite",
XG:!0},n=>Vi(n,e,B))},iuL=function(f,e){return mp(f,{mode:"readwrite",
XG:!0},B=>l3(B,e,"offlineOrchestrationActionWrapperEntity"))},Nt=function(f,e){return mp(f,{mode:"readwrite",
XG:!0},B=>u3(B,e))},f3M=function(f){return mp(f,{mode:"readwrite",
XG:!0},e=>FE(e,"videoPlaybackPositionEntity"))},hx=function(f,e,B){return mp(f,{mode:"readonly",
XG:!0},n=>Ax(n,e,B))},gm=function(f,e,B){return mp(f,{mode:"readonly",
XG:!0},n=>jn(n,e,B))},n1B=async function(){try{const e=await g.f8();
if(e&&g.kI()&&typeof g.Kw.BroadcastChannel!=="undefined"){var f=new eBF;return new BjB(e,f)}}catch(e){e instanceof Error&&g.J(e)}},EJ=function(){Sn||(Sn=n1B());
return Sn},r6M=function(f){f=f.options?.persistenceOption;
return f==="ENTITY_PERSISTENCE_OPTION_PERSIST"||f==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},d7H=async function(f,e,B){var n=g.nJ(),r=B.refreshData,L=B.isEnqueuedForExpiredStreamUrlRefetch,d=B.wQ,t=B.offlineSourceData;
B=B.mediaCapabilities;f={entityKey:f};r&&(f.refreshData=r);L&&(f.isExpiredStreamUrlRefetch=L);d&&(f.downloadParameters=d);t&&(f.offlineSourceData=t);e={context:g.XQ(e),signatureTimestamp:20492,videos:[f]};B&&(e.mediaCapabilities=B);r=g.dH(L7u);try{var H=await g.JQ(n,e,r,void 0,{Wp:!0})}catch(k){if(k instanceof g.DT)throw H=`GetPDE network manager error: ${k.message}`,Qi(H,k),Error(H);Qi("GetPDE fetch request error",k);throw Error("GetPDE fetch request error");}n=H.errorMetadata?.status;if(H)n!==void 0&&
TQ(n,"PDE");else throw Qi("Network request failed for PDE"),Error("Network request failed for PDE");return H},txg=async function(f){const e=await EJ();
e&&await mp(e,"readwrite",B=>{const n={};for(const r of f){if(!r.entityKey||!r6M(r))continue;const L=g.FG(r.payload);let d=void 0;r.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(d=()=>Vi(B,r.payload[L],L));
r.type==="ENTITY_MUTATION_TYPE_DELETE"&&(d=()=>u3(B,r.entityKey));
r.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(d=()=>PEF(B,r.entityKey,r.payload[L],L));
d&&(n[r.entityKey]=n[r.entityKey]?n[r.entityKey].then(d):d())}return g.FD.all(Object.values(n))})},D8=async function(f){!(f=f.mutations)||f.length<=0||(g.r7&&g.r7.dispatch(SjB({type:"ENTITY_LOADED",
payload:f})),await txg(f),f.length=0)},Hrg=function(f){return f!==void 0},kpT=function(f){var e=g.Sc();
e=Object.assign({},e);f=Object.assign({},f);for(const B in e)f[B]?(e[B]!==4&&(e[B]=f[B]),delete f[B]):e[B]!==2&&(e[B]=4);Object.assign(e,f);g.c0O(e);JSON.stringify(e);return e},CwB=async function(f){const e=await g.f8();
return e?g.SY(await g.TH(e),["index","media","captions"],{mode:"readwrite",XG:!0},B=>{const n=IDBKeyRange.bound(f+"|",f+"~");B=[B.objectStore("index").delete(n),B.objectStore("media").delete(n),B.objectStore("captions").delete(n)];return g.FD.all(B).then(()=>{})}):void 0},wre=async function(){const f=await g.f8();
if(!f)throw g.uo("rvdfd");return g.SY(await g.TH(f),["index","media"],{mode:"readwrite",XG:!0},e=>{const B={};return g.Jn(e.objectStore("index"),{},n=>{var r=n.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let L=g.FD.resolve(void 0);if(r){const d=r[1];r=r[2];B[d]=B[d]||{};B[d][r]=g.Oaw(n.getValue()?.fmts)}else L=n.delete().then(()=>{});
return g.FD.all([g.MM(n),L]).then(([d])=>d)}).then(()=>{const n={};
for(const L of Object.keys(B)){const d=B[L].v;n[L]=B[L].a&&d?1:2}const r=kpT(n);return g.jQO(e.objectStore("media"),{},L=>{const d=L.cursor.key.match(g.uNO);d&&n[d[1]]||e.objectStore("media").delete(L.cursor.key);return g.K7H(L)}).then(()=>r)})})},v1e=async function(f,e){var B=await g.f8();
if(!B)throw g.uo("wct");B=await g.TH(B);await g.SY(B,["captions"],{mode:"readwrite",XG:!0},n=>{const r=[];n=n.objectStore("captions");for(let L=0;L<e.length;L++){const d=n.put(e[L],f+"|"+e[L].metadata.vss_id);r.push(d)}return g.FD.all(r)})},brI=async function(f){f=IDBKeyRange.bound(f+"|",f+"~");
const e=await g.f8();if(!e)throw g.uo("gactfv");return(await g.TH(e)).getAll("captions",f)},Zre=async function(f){g.Qm(f,0);
return CwB(f)},RBL=function(f){return{context:g.rH(),
videoIds:f}},K7T=function(f){return{context:g.rH(),
playlistIds:f}},qlG=function(f){return{context:g.rH(),
offlinePlaylistSyncChecks:f}},a3M=function(){Jx||(Jx=new zBF);
return Jx},prB=function(f,e){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:f},metadata:e,statusCode:void 0,csn:void 0,can:void 0}},c6B=function(f,e,B){B||(B=f.C.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),B||(B=g.HR(16),f.C.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",B)));
f={flowNonce:B,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:e.eventType};e.metadata&&(f.flowMetadata=e.metadata);e.statusCode!==void 0&&(f.flowEventStatus=e.statusCode);e.csn&&(f.csn=e.csn);e.can&&(f.can=e.can);g.t$("flowEvent",f,void 0)},YlM=async function(f){var e=await mp(f,{mode:"readonly",
XG:!0},b=>jn(b,"playbackData").then(K=>{var Y=K.map(N=>N.transfer).filter(N=>!!N),l=K.map(N=>N.offlineVideoPolicy).filter(N=>!!N),m=K.filter(N=>!!N.key).map(N=>g.pe(g.aJ(N.key).entityId,"downloadStatusEntity"));
Y=jn(b,"transfer",Y);l=jn(b,"offlineVideoPolicy",l);m=jn(b,"downloadStatusEntity",m);const F=Y.then(N=>{N=N.reduce((E,Lw)=>{Lw?.offlineVideoStreams&&E.push(...Lw.offlineVideoStreams);return E},[]).filter(E=>!!E);
return jn(b,"offlineVideoStreams",N)});
return g.FD.all([Y,l,F,m]).then(([N,E,Lw,d6])=>[K,N,E,Lw,d6])}));
f=await mp(f,{mode:"readonly",XG:!0},b=>jn(b,"mainDownloadsListEntity").then(K=>K[0]?.downloads??[]));
const [B,n,r,L,d]=e,t={},H={},k={},C={},w={};e=[];for(var v of n)v&&(t[v.key]=v);for(const b of r)b&&(H[b.key]=b);for(const b of d)b&&(k[b.key]=b);for(const b of L)b&&(C[b.key]=b);for(const b of f)w[b.videoItem??""]=!0,b.videoItem&&(v=g.aJ(b.videoItem)?.entityId??"",e.push({externalVideoId:v}));return{offlineVideos:B.filter(b=>{if(!b||!b.key||!b.offlineVideoPolicy)return!1;b=g.aJ(b.key).entityId;b=g.pe(b,"downloadStatusEntity");return!(b&&k[b]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(b=>
{var K=t[b.transfer];
const Y=[];if(K?.offlineVideoStreams)for(var l of K.offlineVideoStreams){var m=C[l];m&&Y.push(m)}l=H[b.offlineVideoPolicy];m=b?.playerResponseTimestamp;var F=g.aJ(l.key).entityId;b=g.pe(F,"mainVideoEntity");if(l.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var N="OFFLINE_VIDEO_STATE_DISABLED";l.expirationTimestamp&&Number(l.expirationTimestamp)<Date.now()/1E3&&(N="OFFLINE_VIDEO_STATE_EXPIRED")}else if(l.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")N="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(K?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":N="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":N="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":N="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":N="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":N="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":N="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:N="OFFLINE_VIDEO_STATE_UNKNOWN"}if(N==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(K?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":N="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":N="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":N="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}F={id:F,videoState:N};
K?.cotn&&(F.cotn=K.cotn);K?.maximumDownloadQuality&&(F.selectedVideoQuality=K?.maximumDownloadQuality);K?.lastProgressTimeMs&&(F.lastProgressTimeMs=K.lastProgressTimeMs);m&&(F.playerResponseSavedTimeMs=String(Number(m)*1E3));K=String;m=0;for(const E of Y)if(E.streamsProgress)for(const Lw of E.streamsProgress)m+=Number(Lw.numBytesDownloaded??0);F.downloadedBytes=K(m);F.selectedOfflineMode=w[b]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";l.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(F.offlinePlaybackDisabledReason=
l.offlinePlaybackDisabledReason);return F}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:e}}}},jQL=function(){try{let B=g.zO("ytglobal.locks_");
if(B)return B;var f;if(f=navigator){var e=navigator;f="locks"in e&&!!e.locks}if(f)return g.Kw.localStorage&&g.Kw.localStorage.getItem("noop"),B=new A6g,g.qH("ytglobal.locks_",B),B}catch{}},Mt=function(f){if(f.includes(":"))throw Error(`Invalid user cache name: ${f}`);
return`${f}:${g.Ho("CacheStorage get")}`},OrH=async function(){return GQ!==void 0?GQ:GQ=new Promise(async f=>{try{await xo.open("test-only"),await xo.delete("test-only")}catch(e){if(e instanceof Error&&e.name==="SecurityError"){f(!1);
return}}f("caches"in window)})},sJ=async function(){if(await OrH())return W3||(W3=new o1g),W3},Qi=function(f,e,B){g.Yv(new g.Dj(`Woffle: ${f}`,B?{cotn:B}:""));
e instanceof Error&&g.Yv(e)},VxL=async function(f){f=await YlM(f);
g.t$("offlineStateSnapshot",f)},XE=function(f,e){g.yW(f.api,"onOfflineOperationFailure",e);
f.C?.postMessage(e)},l3e=function(f){if(!f.J&&!f.C){var e=jQL();
if(e){f.J=!0;var B=g.Ho("OfflineLockManager");e.request(`${"woffle_orchestration_leader"}:${B}`,{},async()=>{try{f.G=new g.rF,f.C=!0,f.J=!1,await f.K(),await f.G.promise}catch(n){f.KI(),n instanceof Error&&(n.args=[{name:"WoLockManagerError",N1:n.name}],g.J(n))}})}}},yi=function(f){f.X&&f.U&&f.W&&f.visibility.isBackground()?f.V.M0(6E4):f.V.stop()},uyT=function(f){f.C&&(f.W=!0,yi(f))},F7T=function(f,e){f.C&&(f.U=e,yi(f))},m7x=function(f,e){f.C&&(f.X=e,yi(f))},P3=function(f){f.offlineDeleteReason=f.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
f.offlineModeType=f.offlineModeType??"OFFLINE_NOW";g.t$("offlineDeleteEvent",f)},I9=function(f,{videoId:e,
RJ:B,offlineModeType:n}){f.encryptedVideoId=e;f.cotn=B?.cotn;f.offlineabilityFormatType=B?.maximumDownloadQuality;f.isRefresh=B?.isRefresh??!1;f.softErrorCount=B?.transferRetryCount??0;f.offlineModeType=n??"OFFLINE_NOW";(f.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&f.statusType==="UNKNOWN_STATUS_TYPE"||!f.transferStatusType&&!f.statusType)&&g.Yv(Error("Woffle unknown transfer status"));g.t$("offlineTransferStatusChanged",f)},U7e=function(f,e,B,n){n={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!n};e&&B&&(e=Math.floor(e/1024).toFixed(),B=Math.floor(B/1024).toFixed(),n.alreadyDownloadedKbytes=e,n.totalFetchedKbytes=e,n.totalContentKbytes=B);I9(n,f)},NjF=function(f){I9({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},f)},hBe=function(f){switch(f){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
$o=function(f){return(f.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},i3=function(f){return f.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!f.entityKey},fc=function(f){return f.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!f.entityKey},e0=function(f){return f.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!f.entityKey},g1V=function(f){return f.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!f.entityKey},BC=async function(f,e,B,n,r=!1){const L=
g.pe(f,e),d=g.pe(f,"downloadStatusEntity");
f=await mp(B,{mode:"readonly",XG:!0},H=>g.FD.all([Ax(H,L,e),Ax(H,d,"downloadStatusEntity")]));
const t=f.length?f[0]:void 0;if(t){let H=f.length>1?f[1]:void 0;if(H){if(H.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!r)return;H.downloadState=n}else H={key:d,downloadState:n};g.mj(t,SlI,H);await mp(B,{mode:"readwrite",XG:!0},k=>g.FD.all([Vi(k,t,e),Vi(k,H,"downloadStatusEntity")]))}},nc=function(f,e){return f.actionType===e.actionType&&f.entityKey===e.entityKey},r3=function(f,e){if(f&&f.transferState!=="TRANSFER_STATE_COMPLETE"&&f.transferState!=="TRANSFER_STATE_FAILED"){const B=g.aJ(f.key).entityId;
I9({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:B,RJ:f,offlineModeType:e})}},Lc=function(f){if(!f||!f.thumbnails)return[];
const e=[];for(const B of f.thumbnails)B.url&&e.push(B.url);return e},d3=async function(f,e,B=[]){if(!B.length)return[];
e=await gm(f,e);f=new Set;for(var n of e)if(e=n.id||n.key)e=g.aJ(e).entityId,f.add(e);n=[];for(const r of B)B=r.offlineVideoData,B?.videoId&&!f.has(B.videoId)&&n.push(r);return n},ty=function(f,e,B){return new g.qk(f,{cotn:e,
raw_player_response:B,download_media:!0,start:Infinity,disable_watch_next:!0})},HC=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},Cc=function(f){if(!f.key)throw Error("Entity key is required.");
if(!f.actionProto)throw Error("OfflineOrchestrationAction is required.");const e=g.aJ(f.key),B=g.aJ(f.actionProto.entityKey);return new kS(B.entityType,e.entityId,f.actionProto,f.parentActionId,f.rootActionId,f.childActionIds,f.prereqActionId,f.postreqActionIds,f.retryScheduleIndex,f.hasChildActionFailed,Number(f.enqueueTimeSec)*1E3)},w3=function(f){return{key:g.pe(f.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:f.action,parentActionId:f.parentActionId,rootActionId:f.rootActionId,childActionIds:f.childActionIds,prereqActionId:f.prereqActionId,postreqActionIds:f.postreqActionIds,retryScheduleIndex:f.retryScheduleIndex,hasChildActionFailed:f.hasChildActionFailed,enqueueTimeSec:(f.C/1E3).toFixed()}},E1g=async function(){const f=await sJ();
return f?f.delete("yt-player-local-img"):!0},vC=async function(f){const e=await sJ();
if(!e)throw Error("Cache API not supported");if(f.length){var B=await e.open("yt-player-local-img");await Promise.all(f.map(n=>B.delete(n)))}},b9=async function(f){const e=await sJ();
if(!e)throw Error("Cache API not supported");f.length&&await (await e.open("yt-player-local-img")).addAll(f)},Zn=async function(f,e,B,n,r){const L=g.pe(f,"mainVideoEntity"),d=g.pe(f,"ytMainChannelEntity"),t=g.pe(f,"transfer"),H=g.pe(f,"videoDownloadContextEntity");
var k=await mp(e,{mode:"readonly",XG:!0},N=>g.FD.all([Ax(N,L,"mainVideoEntity"),Ax(N,d,"ytMainChannelEntity"),Ax(N,t,"transfer"),Ax(N,H,"videoDownloadContextEntity"),jn(N,"ytMainChannelEntity"),jn(N,"offlineOrchestrationActionWrapperEntity")]));
const [C,w,v,b,K,Y]=k;if(C||w){k=C?Lc(C.thumbnail):[];var l=w?await QQu(w,K):[];await vC(k.concat(l))}const m=[],F=g.pe(f,"downloadStatusEntity");for(const N of Y)k=g.aJ(N.key).entityId,l=Cc(N),l=g.aJ(l.action.entityKey).entityId,k!==f&&l!==f||nc(B,N.actionProto)||m.push(N.key);await mp(e,{mode:"readwrite",XG:!0},N=>{const E=m.map(Lw=>u3(N,Lw));
E.push(u3(N,L,{sX:!0}));E.push(u3(N,F,{sX:!0}));return g.FD.all(E)});
f=b?.offlineModeType;r&&(P3(r),r.offlineModeType&&(f=r.offlineModeType));r3(v,f);XE(n,{entityKey:L,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},Ri=async function(f,e,B,n){const r=g.pe(f,"mainPlaylistEntity"),L=g.pe(f,"ytMainChannelEntity");
var d=await mp(e,{mode:"readonly",XG:!0},N=>g.FD.all([Ax(N,r,"mainPlaylistEntity"),Ax(N,L,"ytMainChannelEntity"),jn(N,"mainPlaylistEntity"),jn(N,"mainDownloadsListEntity"),jn(N,"ytMainChannelEntity"),jn(N,"offlineOrchestrationActionWrapperEntity")]));
const [t,H,k,C,w,v]=d;if(t||H){d=t?Tjx(t):[];var b=H?await QQu(H,w):[];await vC(d.concat(b))}d=[];b=new Map;if(t){d=await D7T(t,k,C);for(var K of d)b.set(K,{videoId:K,playlistId:f,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});K=await mp(e,{mode:"readonly",XG:!0},Lw=>g.FD.all([jn(Lw,"transfer"),jn(Lw,"videoDownloadContextEntity")]));
const [N,E]=K;for(var Y of N)K=g.aJ(Y.key).entityId,(K=b.get(K))&&Y&&(K.cotn=Y.cotn);for(var l of E)Y=g.aJ(l.key).entityId,(Y=b.get(Y))&&l&&(Y.offlineModeType=l.offlineModeType)}const m=[];for(const N of v)l=g.aJ(N.key).entityId,Y=Cc(N),l!==f&&Y.rootActionId!==f||nc(B,N.actionProto)||m.push(N.key);const F=g.pe(f,"mainPlaylistEntity");await mp(e,{mode:"readwrite",XG:!0},N=>{const E=m.map(Lw=>u3(N,Lw));
E.push(u3(N,F,{sX:!0}));return g.FD.all(E)});
if(t&&(d.reverse(),d))for(const N of d)await Zn(N,e,B,n,b.get(N))},Kc=async function(f,e,B,n){const r=g.pe("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),L=new Map;
f=await mp(f,{mode:"readwrite",XG:!0},d=>{const t=jn(d,"transfer"),H=jn(d,"offlineOrchestrationActionWrapperEntity"),k=jn(d,"videoDownloadContextEntity"),C=Ax(d,r,"mainDownloadsListEntity");return g.FD.all([t,H,k,C]).then(([w,v,b,K])=>{const Y=J62.map(l=>FE(d,l));
for(const l of v)nc(e,l.actionProto)||Y.push(u3(d,l.key,{sX:!0}));K&&(K.downloads=[],Y.push(Vi(d,K,"mainDownloadsListEntity")));if(b)for(const l of b)v=g.aJ(l.key).entityId,v=g.pe(v,"transfer"),L.set(v,l.offlineModeType);return g.FD.all(Y).then(()=>w)})});
for(const d of f){r3(d,L.get(d.key));f=g.aJ(d.key).entityId;const t={videoId:f,offlineDeleteReason:n,cotn:d.cotn,offlineModeType:L.get(d.key)};P3(t);f=g.pe(f,"mainVideoEntity");XE(B,{entityKey:f,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await E1g()},Tjx=function(f,e){let B=[];
if(f.thumbnailStyleData)for(const n of f.thumbnailStyleData)B=B.concat(Lc(n?.value?.collageThumbnail?.coverThumbnail));f=Lc(e);return B.concat(f)},D7T=async function(f,e,B){const n=[],r=new Set;
if(B.length)for(var L of B)if(L.downloads?.length)for(const d of L.downloads)d.videoItem&&(B=g.aJ(d.videoItem).entityId,r.add(B));if(f.videos){for(const d of f.videos)L=JSON.parse(g.aJ(d).entityId),L.videoId&&!r.has(L.videoId)&&n.push(L.videoId);for(const d of e)if(d.key!==f.key&&(e=d.videos))for(const t of e)e=JSON.parse(g.aJ(t).entityId),e.videoId&&(e=n.indexOf(e.videoId),e!==-1&&n.splice(e,1))}return n},QQu=async function(f,e){const B=Lc(f.avatar);
for(const n of e)if(n.id!==f.id)for(const r of Lc(n.avatar))e=B.indexOf(r),e!==-1&&B.splice(e,1);return B},Mxe=async function(f){const e=g.u(f.frameworkUpdates,q0);
f.frameworkUpdates&&e&&await D8(e)},W7B=function(f){if(f.onResponseReceivedActions?.length&&(f=g.u(g.u(f.onResponseReceivedActions[0],GpL),x7F)?.actions,f?.length))return f},sQI=async function(f){if(!f)return[];
f=await hx(f,zA,"mainDownloadsListEntity");return f?.downloads?.length?f.downloads.map(e=>e.videoItem??""):[]},ai=async function(f,e){const B=await Xrx(f,e);
B&&await mp(f,{mode:"readwrite",XG:!0},n=>{const r=[Vi(n,B.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];B.mainDownloadsListEntity&&r.push(Vi(n,B.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.FD.all(r)})},Xrx=async function(f,e){const B=g.pe("main_downloads_library_id","mainDownloadsLibraryEntity"),n=g.pe("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
f=await mp(f,{mode:"readonly",XG:!0},H=>g.FD.all([Ax(H,B,"mainDownloadsLibraryEntity"),Ax(H,n,"mainDownloadsListEntity")]));
let [r,L]=f;f=r;let d=L;f||(f={id:B});for(const H of e)if(H===zA){if(f.smartDownloadsList)return;f.smartDownloadsList=H}else{var t=g.aJ(H).entityType;e={};t==="mainPlaylistEntity"?e.playlistItem=H:t==="mainVideoEntity"&&(e.videoItem=H);if(!g.TL(e)){if(d?.downloads){t=!1;for(const k of d.downloads)if(k.playlistItem===H||k.videoItem===H){t=!0;break}t||d.downloads.push(e)}else d={id:n,downloads:[e]};f.downloadsList=n}}return{mainDownloadsLibraryEntity:f,mainDownloadsListEntity:d}},pc=async function(f,
e){const B=g.pe("main_downloads_library_id","mainDownloadsLibraryEntity"),n=g.pe("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var r=await mp(f,{mode:"readonly",XG:!0},H=>g.FD.all([Ax(H,B,"mainDownloadsLibraryEntity"),Ax(H,n,"mainDownloadsListEntity"),Ax(H,zA,"mainDownloadsListEntity")]));
const [L,d,t]=r;if(L){if(e===zA&&t?.downloads)t.downloads=[];else if(d?.downloads){r=g.aJ(e).entityType;for(let H=0;H<d.downloads.length;H++){const k=d.downloads[H];if(r==="mainVideoEntity"&&k.videoItem===e){d.downloads.splice(H,1);break}else if(r==="mainPlaylistEntity"&&k.playlistItem===e){d.downloads.splice(H,1);break}}}await mp(f,{mode:"readwrite",XG:!0},H=>{const k=[Vi(H,L,"mainDownloadsLibraryEntity")];d&&k.push(Vi(H,d,"mainDownloadsListEntity"));t&&k.push(Vi(H,t,"mainDownloadsListEntity"));
return g.FD.all(k)})}},cC=async function(f,e){const B=g.pe(e,"transfer"),n=g.pe(e,"videoDownloadContextEntity");
f=await mp(f,{mode:"readonly",XG:!0},d=>g.FD.all([Ax(d,B,"transfer"),Ax(d,n,"videoDownloadContextEntity")]));
const [r,L]=f;return{videoId:e,cotn:r?.cotn,offlineModeType:L?.offlineModeType}},YS=async function(f,e,B,n,r){const L=g.pe(f,"musicTrack"),d=g.pe(f,"transfer");
var t=await mp(e,{mode:"readonly",XG:!0},K=>g.FD.all([Ax(K,L,"musicTrack"),Ax(K,d,"transfer"),jn(K,"musicTrack"),jn(K,"offlineOrchestrationActionWrapperEntity")]));
const [H,k,C,w]=t;H&&(t=await y6B(H,C),await vC(t));const v=[];for(const K of w){t=g.aJ(K.key).entityId;var b=Cc(K);b=g.aJ(b.action.entityKey).entityId;t!==f&&b!==f||nc(B,K.actionProto)||v.push(K.key)}await mp(e,{mode:"readwrite",XG:!0},K=>{const Y=v.map(l=>u3(K,l));
Y.push(u3(K,L,{sX:!0}));return g.FD.all(Y)});
r3(k);r&&P3(r);XE(n,{entityKey:L,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},Ay=async function(f,e,B,n,r){const L=g.pe(f,e),d=g.pe("music_downloads_library_id","musicDownloadsLibraryEntity");
var t=await mp(B,{mode:"readonly",XG:!0},m=>g.FD.all([Ax(m,L,e),Ax(m,d,"musicDownloadsLibraryEntity"),jn(m,e),jn(m,"offlineOrchestrationActionWrapperEntity")]));
const [H,k,C,w]=t;H&&(t=await y6B(H,C),await vC(t));let v=[];t=new Map;if(H){v=await PwH(H,C,k);for(var b of v){const m=g.aJ(b).entityId;t.set(m,{videoId:m,playlistId:f,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}b=await gm(B,"transfer");for(var K of b)b=g.aJ(K.key).entityId,(b=t.get(b))&&K&&(b.cotn=K.cotn)}const Y=[];for(const m of w)K=g.aJ(m.key).entityId,b=Cc(m),K!==f&&b.rootActionId!==f||nc(n,m.actionProto)||Y.push(m.key);const l=g.pe(f,e);await mp(B,{mode:"readwrite",XG:!0},
m=>{const F=Y.map(N=>u3(m,N));
F.push(u3(m,l,{sX:!0}));return g.FD.all(F)});
if(H&&(v.reverse(),v.length))for(const m of v)(f=g.aJ(m).entityId)&&await YS(f,B,n,r,t.get(f))},j0=async function(f,e,B){f=await mp(f,{mode:"readwrite",
XG:!0},n=>{const r=jn(n,"transfer"),L=jn(n,"offlineOrchestrationActionWrapperEntity");return g.FD.all([r,L]).then(([d,t])=>{const H=I32.map(k=>FE(n,k));
for(const k of t){t=g.aJ(k.actionProto.entityKey).entityType==="musicTrack";const C=k.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";nc(e,k.actionProto)||t&&(!t||C)||H.push(u3(n,k.key,{sX:!0}))}return g.FD.all(H).then(()=>d)})});
for(const n of f)r3(n),f=g.aJ(n.key).entityId,P3({videoId:f,offlineDeleteReason:void 0,cotn:n.cotn}),f=g.pe(f,"musicTrack"),XE(B,{entityKey:f,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await E1g()},$7T=function(f){let e;
for(const B of f.additionalMetadatas)B.offlineMusicVideoData&&(e=B.offlineMusicVideoData);return{id:g.pe(f.videoId,"musicTrack"),videoId:f.videoId,title:f.title,thumbnailDetails:f.thumbnail,lengthMs:String(Number(f.lengthSeconds)*1E3),albumTitle:e?.releaseTitle,musicVideoType:e?.musicVideoType,contentRating:{explicitType:e?.explicitType},artistNames:e?.byline||e?.channelName,downloadMetadata:g.pe(f.videoId,"musicTrackDownloadMetadataEntity")}},PwH=async function(f,e,B){const n=[],r=new Set;
if(B?.downloadedTracks?.length)for(const L of B.downloadedTracks)r.add(L);if(f.tracks){for(const L of f.tracks)r.has(L)||n.push(L);for(const L of e)if(L.id!==f.id&&(e=L.tracks))for(const d of e)e=n.indexOf(d),e!==-1&&n.splice(e,1)}return n},y6B=async function(f,e){const B=Lc(f.thumbnailDetails);
for(const n of e)if(n.id!==f.id)for(const r of Lc(n.thumbnailDetails))e=B.indexOf(r),e!==-1&&B.splice(e,1);return B},O9=async function(f,e){var B=g.pe("music_downloads_library_id","musicDownloadsLibraryEntity");
let n=await hx(f,B,"musicDownloadsLibraryEntity");n||(n={id:B});B=g.aJ(e).entityType;B==="musicTrack"?n.downloadedTracks?.includes(e)||(n.downloadedTracks=(n.downloadedTracks??[]).concat(e)):B==="musicPlaylist"?n.downloadedPlaylists?.includes(e)||(n.downloadedPlaylists=(n.downloadedPlaylists??[]).concat(e)):B!=="musicAlbumRelease"||n.downloadedAlbumReleases?.includes(e)||(n.downloadedAlbumReleases=(n.downloadedAlbumReleases??[]).concat(e));await UJ(f,n,"musicDownloadsLibraryEntity")},oi=async function(f,
e){var B=g.pe("music_downloads_library_id","musicDownloadsLibraryEntity");
if(B=await hx(f,B,"musicDownloadsLibraryEntity")){var n=g.aJ(e).entityType;let r;n==="musicTrack"?r=B.downloadedTracks:n==="musicPlaylist"&&(r=B.downloadedPlaylists);if(r?.length)for(n=0;n<r.length;n++)if(r[n]===e){r.splice(n,1);break}await UJ(f,B,"musicDownloadsLibraryEntity")}},irB=function(f){var e=f.videos;
f=[];const B=[];if(e)for(const r of e){var n=r.offlineVideoData.videoId;e=g.pe(n,"musicTrack");n=g.pe(n,"musicTrackDownloadMetadataEntity");f.push(e);B.push(n)}return{vG:f,Jn:B}},Vu=function(f,e,B){e={track:$7T(e)};
B&&(e.playlistId=B);if(f=g.u(f.actionMetadata,fgB))e.maximumDownloadQuality=f.maximumDownloadQuality;return{musicTrackEntityActionMetadata:e}},Bfe=async function(f){var e=g.nJ();
f=RBL(f);const B=g.dH(ekF);try{var n=await g.JQ(e,f,B,void 0,{Wp:!0})}catch(r){if(r instanceof g.DT)throw n=`GetOffline network manager error: ${r.message}`,Qi(n,r),Error(n);Qi("GetOffline fetch request error",r);throw Error("GetOffline fetch request error");}e=n.errorMetadata?.status;if(!n)throw Qi("Network request failed"),Error("Network request failed");if(e!==void 0)TQ(e);else if(!n.videos||!n.videos.length)throw Qi("No data"),Error("No data");return n.videos.map(r=>r.offlineVideoData)},l9=async function(f){var e=
g.nJ();
f=K7T(f);const B=g.dH(ekF);try{var n=await g.JQ(e,f,B,void 0,{Wp:!0})}catch(r){if(r instanceof g.DT)throw n=`GetOffline network manager error for playlist: ${r.message}`,Qi(n,r),Error(n);Qi("GetOffline fetch request error for playlist",r);throw Error("GetOffline fetch request error for playlist");}e=n.errorMetadata?.status;if(!n)throw Qi("Network request failed for playlist"),Error("Network request failed for playlist");if(e!==void 0)TQ(e,"playlist");else if(!n.playlists||!n.playlists.length)throw Qi("No data for playlist"),
Error("No data for playlist");return n.playlists.map(r=>r.offlinePlaylistData)},r8F=async function(f,e,B,n){const r=await EJ();
if(!r)return[];var L=[];n?.length?L=n:L=await gm(r,"mainPlaylistEntity");if(!L.length)return[];n=[];const d=Date.now()/1E3;for(const C of L){var t=C.downloadState?await hx(r,C.downloadState,"mainPlaylistDownloadStateEntity"):void 0,H=(L=C?.entityMetadata)&&L.nextAutoRefreshIntervalSeconds?Number(L.nextAutoRefreshIntervalSeconds):NaN;H=Number.isNaN(H)?f:H;var k=t?.lastSyncedTimestampMillis?Number(t?.lastSyncedTimestampMillis)/1E3:0;t=t?.addedTimestampMillis?Number(t?.addedTimestampMillis)/1E3:0;if(B||
!L||k+H<=d){H=[];if(C.videos?.length)for(const w of C.videos)k=JSON.parse(g.aJ(w).entityId),k.videoId&&H.push(k.videoId);k="0";L&&(k=String(Number(L.offlineLastModifiedTimestampSeconds??0).toFixed()));n.push({playlistId:C.playlistId,videoIds:H,offlineLastModifiedTimestamp:k,autoSync:e,offlineDateAddedTimestamp:String(t.toFixed())})}}return n.length?await nlV(n):[]},L2I=async function(){var f=await EJ();
if(!f)return!1;f=await gm(f,"refresh");if(!f[0]?.refreshTime)return!1;f=Number(f[0].refreshTime);const e=Date.now()/1E3;return isFinite(f)&&e>=f},tmI=async function(f,e){let B;
try{const n=await dSF(f,e);await Mxe(n);B=W7B(n)}catch(n){Qi("getAndProcessSmartDownloadsResponse request or processing error",n)}return B},HtB=async function(f,e,B,n){const r=await EJ();
if(!r)return[];var L=[];n?.length?L=n:L=await gm(r,"musicPlaylist");if(!L.length)return[];n=[];const d=Date.now()/1E3;for(const k of L){var t=(L=k?.entityMetadata)&&L.nextAutoRefreshIntervalSeconds?Number(L.nextAutoRefreshIntervalSeconds):NaN;const C=Number.isNaN(t)?f:t;let w=t=0;var H="DOWNLOAD_SYNC_STATE_UNKNOWN";k.downloadMetadata&&(H=await hx(r,k.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),t=Number(H?.addedTimestampMillis??"0")/1E3,w=Number(H?.lastModifiedTimestampMillis??"0")/1E3,
H=H?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(B||H!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!L||Number(L.lastSyncedTimestampSeconds??0)+C<=d){L=[];if(k.tracks?.length)for(const v of k.tracks)L.push(g.aJ(v).entityId);n.push({playlistId:k.playlistId,videoIds:L,offlineLastModifiedTimestamp:String(w.toFixed()),autoSync:e,offlineDateAddedTimestamp:String(t.toFixed())})}}return n.length?await nlV(n):[]},dSF=async function(f,e){var B=g.nJ(),n=await EJ();
let r;n&&(r=await YlM(n));n=r;f={context:g.rH(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:f},offlineClientState:n,clientStateRequestData:{preferredFormatType:e}}}};e=g.dH(k72);try{var L=await g.JQ(B,f,e,void 0,{Wp:!0})}catch(d){if(d instanceof g.DT)throw L=`DPS network manager error for smart downloads: ${d.message}`,Qi(L,d),Error(L);Qi("DPS fetch request error for smart downloads",d);throw Error("DPS fetch request error for smart downloads");
}B=L.errorMetadata?.status;if(L)B!==void 0&&TQ(B,"smart downloads");else throw Qi("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return L},wUI=async function(f,e){var B=g.nJ();
f={context:g.rH(),videoPlaybackPositionEntities:f,lastSyncTimestampUsec:e};e=g.dH(ChV);try{var n=await g.JQ(B,f,e,void 0,{Wp:!0})}catch(r){if(r instanceof g.DT)throw n=`VPPS network manager error: ${r.message}`,Qi(n,r),Error(n);Qi("VPPS fetch request error",r);throw Error("VPPS fetch request error");}B=n.errorMetadata?.status;if(n)B!==void 0&&TQ(B,"position sync");else throw Qi("Network request failed for position sync"),Error("Network request failed for position sync");return n},TQ=function(f,e){e=
e?` for ${e}`:"";
if(f===0)throw f=`Empty response body${e}`,Qi(f),Error(f);f=`Response with error${e}`;Qi(f);throw Error(f);},nlV=async function(f){var e=g.nJ();
f=qlG(f);const B=g.dH(vl2);try{var n=await g.JQ(e,f,B,void 0,{Wp:!0})}catch(r){if(r instanceof g.DT)throw n=`offlinePlaylistSyncCheck network manager error: ${r.message}`,Qi(n,r),Error(n);Qi("offlinePlaylistSyncCheck fetch request error",r);throw Error("offlinePlaylistSyncCheck fetch request error");}e=n.errorMetadata?.status;if(!n)throw Qi("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(e!==void 0)TQ(e,"playlist sync");else if(!n.offlinePlaylistSyncCheckDatas||
!n.offlinePlaylistSyncCheckDatas.length)throw Qi("No data for playlist sync"),Error("No data for playlist sync");return n.offlinePlaylistSyncCheckDatas.map(r=>r.offlinePlaylistSyncCheckData)},bte=async function(f,e){const B=new Map;
for(const n of e)B.set(n,await f.G(n));return B},u9=function(f,e,B,n,r,L){e=g.pe(e,B);
return{actionType:f,entityKey:e,actionMetadata:{...L,priority:n,retryScheduleIntervalsInSeconds:r}}},K2B=async function(f,e){var B=e.entityKey;
const n=g.u(e.actionMetadata,Fr)?.isEnqueuedForExpiredStreamUrlRefetch;try{let L=void 0;L=await ZtB(f,e);let d;try{{const t=g.u(e.actionMetadata,Fr);var r=t?{maximumDownloadQuality:t.maximumDownloadQuality}:void 0}d=await d7H(B,f.Ta,{isEnqueuedForExpiredStreamUrlRefetch:n,wQ:r,offlineSourceData:L})}catch(t){const H=$o(e)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";Qi("PDE handleAdd error");return mf(e,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",H,"DOWNLOAD_STATE_FAILED")}await RkB(f,d,e);return mf(e,!0,d.orchestrationActions)}catch(L){return f="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",B="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.OU&&L.type==="QUOTA_EXCEEDED"&&(f="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",B="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),Qi("PDE handleAdd error"),mf(e,!1,void 0,f,B,"DOWNLOAD_STATE_FAILED")}},
age=async function(f,e){const B=e.entityKey,n=g.aJ(B).entityId;
var r=await mp(f.C,{mode:"readonly",XG:!0},w=>{const v=Ax(w,B,"playbackData"),b=Ax(w,g.pe(n,"offlineVideoPolicy"),"offlineVideoPolicy");w=Ax(w,g.pe(n,"transfer"),"transfer");return g.FD.all([v,b,w])});
const [L,d,t]=r;if(!L||!d)return mf(e,!0);r=[];var H=L?.playerResponseJson?JSON.parse(L.playerResponseJson):null;if(t&&H){var k=qiH(f,H,t);r=await zkB(f,t)}r={lastPlayerResponseTimestampSeconds:L.playerResponseTimestamp,offlineToken:d.offlineToken,formatIds:r};H={};t?.maximumDownloadQuality&&(H.maximumDownloadQuality=t.maximumDownloadQuality);try{let w=void 0;w=await ZtB(f,e);try{var C=await d7H(B,f.Ta,{refreshData:r,wQ:H,offlineSourceData:w,mediaCapabilities:k})}catch(v){const b=$o(e)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";Qi("PDE handleRefresh error");return mf(e,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",b,"DOWNLOAD_STATE_FAILED")}await RkB(f,C,e);return mf(e,!0,C.orchestrationActions)}catch(w){return f="PDE handleRefresh error",w instanceof Error&&(f=`PDE handleRefresh error: ${w.message}`),k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.OU&&w.type===
"QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),Qi(f),mf(e,!1,void 0,k,C,"DOWNLOAD_STATE_FAILED")}},ZtB=async function(f,e){e=g.aJ(e.entityKey).entityId;
e=g.pe(e,"videoDownloadContextEntity");f=await hx(f.C,e,"videoDownloadContextEntity");return f?.offlineModeType?{offlineModeType:f.offlineModeType}:void 0},mf=function(f,e,B,n,r,L){return new U9(e?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",$o(f),B,n,r,L)},RkB=async function(f,e,B){if(e.frameworkUpdates&&g.u(e.frameworkUpdates,q0)){if(g.u(e.frameworkUpdates,q0).mutations&&g.u(e.frameworkUpdates,q0).mutations.length>0&&g.u(e.frameworkUpdates,q0).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const n=g.aJ(g.u(e.frameworkUpdates,q0).mutations[0].entityKey).entityId,r=await cC(f.C,n),L=g.u(B.actionMetadata,Fr)?.playlistId;
L&&(r.playlistId=L);r.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.yQ(f.Ta)?await Zn(n,f.C,B,f.J,r):g.TT(f.Ta)&&await YS(n,f.C,B,f.J)}await D8(g.u(e.frameworkUpdates,q0))}},qiH=function(f,e,B){e=ty(f.Ta,B.cotn,e);
B=g.K2(e);return g.s86(e,B,f.Ta)},zkB=async function(f,e){const B=[];
if(f=await mp(f.C,{mode:"readonly",XG:!0},n=>{const r=[],L=e.offlineVideoStreams;if(L)for(const d of L)r.push(Ax(n,d,"offlineVideoStreams"));return g.FD.all(r)}))for(const n of f)if(n?.streamsProgress){f=n.streamsProgress;
for(let r=0;r<f.length;r++){const L=JSON.parse(f[r].formatStreamBytes);B.push({itag:L.itag,lmt:L.lastModified,xtags:L.xtags})}}return B},pUg=async function(f,e){e=$o(e);
f=await gm(f.C,"videoPlaybackPositionEntity");if(f.length===0)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",e);try{const B=await N0.getInstance();if(!B)throw Error("prefStorage is undefined");const n=(await B.get("psi"))?.XU??"0",r=await wUI(f,n),L={isPaused:r.watchHistoryPaused,XU:r.syncTimestampUsec};await B.set("psi",L);if(!L.isPaused){const d=g.u(r.frameworkUpdates,q0);r.frameworkUpdates&&d&&await D8(d)}}catch(B){return Qi("PPE handleRefresh error: "+(B instanceof Error?B.message:
"unknown error")),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",e,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",e)},Yig=async function(f,e){const B=$o(e),n=g.aJ(e.entityKey).entityId;
try{const r=await N0.getInstance();if(!r)throw Error("prefStorage is undefined");const L=await r.get("psi"),d=g.u(e.actionMetadata,c8e);if(L?.isPaused===!1&&d?.lastPlaybackPositionSeconds){const t={key:g.pe(n,"videoPlaybackPositionEntity"),videoId:n,lastPlaybackPositionSeconds:d.lastPlaybackPositionSeconds};await UJ(f.C,t,"videoPlaybackPositionEntity")}}catch(r){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
B)},A8B=async function(f,e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;if(n==="!*$_ALL_ENTITIES_!*$")await f3M(f.C);else{const r=g.pe(n,"videoPlaybackPositionEntity");await Nt(f.C,r)}}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},hy=async function(f){return Zre(f)},jDe=async function(f){return(await g.okg(f)).filter(e=>!!e.url).map(e=>
e.url)},g3=function(f,e){var B=g.Eh(e);
if(B===1||B===0)return Promise.resolve();(B=f.player?.getVideoData().videoId===e?f.player:null)&&B.stopVideo();f.J=0;return hy(e)},S0=function(f,e,B=!1,n=!0){e=typeof e==="string"?e:e.videoDetails.videoId;
if(g.Eh(e)===2){var r=f.player?.getVideoData().videoId===e?f.player:null;r&&r.stopVideo();g.Qm(e,2);f.J=2;B?OtT(f.C):n&&olM(f.C)}},lgL=async function(f,e){const B=$o(e);
if(await hx(f.C,e.entityKey,"transfer"))return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);try{await VmF(f,e)}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},u8L=async function(f,e){const B=$o(e),n=await hx(f.C,e.entityKey,"transfer");
if(!n||n.transferState!=="TRANSFER_STATE_COMPLETE")return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);try{await VmF(f,e,!0)}catch(r){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},F2B=async function(f,e){const B=$o(e),n=g.aJ(e.entityKey).entityId,r=await mp(f.C,{mode:"readonly",
XG:!0},t=>{const H=Ax(t,e.entityKey,"transfer");t=Ax(t,g.pe(n,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.FD.all([H,t])}),[L,
d]=r;if(!L||L.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);try{L.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await UJ(f.C,L,"transfer");const t=g.aJ(L.key).entityId;I9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:t,RJ:L,offlineModeType:d?.offlineModeType})}catch(t){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},VmF=async function(f,e,B=!1){const n=g.u(e.actionMetadata,mST),r=g.aJ(e.entityKey).entityId,L=g.pe(r,"downloadStatusEntity");
var d=await mp(f.C,{mode:"readonly",XG:!0},C=>{const w=Ax(C,L,"downloadStatusEntity");C=Ax(C,g.pe(r,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.FD.all([w,C])});
const [t,H]=d;d="TRANSFER_STATE_TRANSFER_IN_QUEUE";t?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(d="TRANSFER_STATE_PAUSED_BY_USER");const k={key:e.entityKey,transferState:d,cotn:g.HR(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:n?.maximumDownloadQuality,preferredAudioTrack:n?.preferredAudioTrack,transferRetryCount:0,isRefresh:B,hasLoggedFirstStarted:!1};await mp(f.C,{mode:"readwrite",XG:!0},C=>{const w=[];B&&w.push(u3(C,g.pe(r,"offlineVideoStreams")));w.push(Vi(C,k,"transfer"));
return g.FD.all(w)});
B&&await hy(r);I9({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:r,RJ:k,offlineModeType:H?.offlineModeType})},Nfu=function(f,e,B,n){if(!f.action.entityKey)throw Error("entityKey is missing.");
const {gf:r,entityId:L}=g.aJ(f.action.entityKey),d={entityType:r,entityId:L,offlineOrchestrationActionType:f.action.actionType,orchestrationAction:{orchestrationActionId:f.actionId}};e&&(d.offlineOrchestrationActionResult=e.status,d.isRetryable=B?!1:e.C,e.J&&(d.offlineOrchestrationFailureReason=USG(e.J,d.isRetryable)));f.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(d.offlineModeType=f.action.actionMetadata.offlineLoggingData.offlineModeType);n&&(d.additionalOrchestrationActions=n.map(t=>
({orchestrationActionId:t.actionId})));
return d},USG=function(f,e){return f!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||e?f==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&e?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":f:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},E9=function(f,e){const B={offlineOrchestrationContext:Nfu(f)};
e=prB(e,B);c6B(a3M(),e,f.rootActionId)},Qu=function(f,e,B,n=[]){e={offlineOrchestrationContext:Nfu(f,e,B,n)};
e=prB(3,e);c6B(a3M(),e,f.rootActionId)},hke=function(f,e){for(const B of e)E9(B,1),f.actions.push(B);
f.actions.sort(f.C)},glG=function(f,e){if(e)for(let B=0;B<f.actions.length;B++)if(e==="!*$_ALL_ENTITIES_!*$"&&f.actions[B].actionId!==e||e!=="!*$_ALL_ENTITIES_!*$"&&f.actions[B].rootActionId===e&&f.actions[B].actionId!==e)f.actions.splice(B,1),B--},SiG=function(f,e){for(const B of f.actions)if(B.actionId===e)return!0;
return!1},DST=async function(f,e,B,n,r){f=new Elu(f,e,B,n,r);
await QDe(f);Tfx(f);return f},QDe=async function(f){const e=await gm(f.G,"offlineOrchestrationActionWrapperEntity");
await TA(f,e)},Tfx=function(f){const e=f.C.actions[0];
return f.V?(e?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&f.V[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(f.W=!0),Promise.resolve()):J8g(f)},J8g=async function(f){if(f.V)throw Error("Already processing an action");
if(!f.HS()){var e=f.C.actions.shift();F7T(f.Ed,!e);if(e!==void 0){e.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&e.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&glG(f.C,e.actionId);var B="";e.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&e.rootActionId===e.actionId&&(B=e.actionId);var n=[e];f.V=n;if(e=f.Cq[e.entityType]){for(const r of n)E9(r,2);try{const r=await bte(e,n.map(L=>L.action));
for(const L of n){const d=r.get(L.action);await Mmx(f,L,d)}glG(f.C,B)}catch(r){Qi("Orchestration error",r);try{await G7B(f,n)}catch(L){Qi("Orchestration retry error",L);for(const d of n)d.retryScheduleIndex<3&&hke(f.C,[d])}}finally{f.V=void 0}}else f.V=void 0;await J8g(f)}}},Mmx=async function(f,e,B){var n=e.retryScheduleIndex+2===3;
if(B.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var r=void 0;try{r=B.V?.map(L=>f.createAction(L,e))}catch(L){Qu(e,B,n);
XE(f.X,{entityKey:e.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});Qi("Orchestration subactions creation error",L);return}Qu(e,B,n,r);if(r){const L=r.map(t=>w3(t));
let d=0;for(;d<r.length&&!f.W;)await mp(f.G,{mode:"readwrite",XG:!0},t=>{const H=[];H.push(l3(t,L.slice(d,d+10),"offlineOrchestrationActionWrapperEntity"));return g.FD.all(H)}),d+=10;
if(f.W){f.W=!1;return}}B=w3(e);await Nt(f.G,B.key);E9(e,4)}else if(B.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(Qu(e,B,n),B.C&&e.retryScheduleIndex+1<3)await G7B(f,[e]);else{n={entityKey:e.action.entityKey,failureReason:B?.G?B.G:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};r=void 0;g.yQ(f.Ta)?r="mainVideoDownloadStateEntity":g.TT(f.Ta)&&(r="musicTrackDownloadMetadataEntity");if(r&&B.downloadState){const L=g.aJ(e.action.entityKey).entityId;await BC(L,r,f.G,B.downloadState)}XE(f.X,n);
B.downloadState==="DOWNLOAD_STATE_FAILED"&&f.Ta.Y("html5_auto_retry_failed_pde_actions")||(Qi("Orchestration result is not retryable, deleting action"),await Nt(f.G,w3(e).key))}},G7B=async function(f,e){for(const B of e){const n=B.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let r=1;B.retryScheduleIndex<n.length&&(r=n[B.retryScheduleIndex]);B.C=r*1E3+Date.now();B.retryScheduleIndex++}await xSB(f,e)},W2M=async function(f,e){return(await gm(f.G,"offlineOrchestrationActionWrapperEntity",e)).filter(Hrg)},TA=async function(f,e){let B=[];
var n=Infinity;let r=4E3;for(const d of e){e=Number(d.enqueueTimeSec);const t=sDu(e);var L=d.retryScheduleIndex;L=L!=null&&L>0;t>0&&L?(n=Math.min(n,e),r=Math.min(t,r)):B.push(d)}isFinite(n)&&(!f.J.isActive()||n<f.K)&&(f.K=n,f.J.start(r));f.U.rZ()||(n=B.length,B=B.filter(d=>!XUe.includes(d.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),n=B.length<n,!f.J.isActive()&&n&&f.J.start(1));
B.length>0&&y8M(f,B);await Tfx(f)},sDu=function(f){f=f*1E3-Date.now();
return f>4E3?4E3:f},y8M=function(f,e){e.length!==0&&e.forEach(B=>{B=Cc(B);
B.retryScheduleIndex<3&&hke(f.C,[B])})},Phg=async function(f){var e=await W2M(f);
const B=[];for(const n of e)e=g.aJ(n.key).entityId,SiG(f.C,e)||B.push(n);await TA(f,B)},xSB=function(f,e){if(e.length===0)return Promise.resolve([]);
e=e.map(B=>w3(B));
return iuL(f.G,e)},IgV=async function(f,e){const B=e.videoId;
let n=!0;if(e.captionTracks.length){const r=hXM(e);f.C=new g.p4(f.wi,e,r)}else if(e.Yp)f.C=new g.cH(f.wi,e.Yp,B,g.W4C(e),e.pz,e.eventId),n=e.pz;else return;return new Promise(r=>{f.C?.W({xf:async()=>{await f.xf(B,n);r()},
v3:()=>{}})})},$Sx=async function(f){f=await brI(f);
return!!f&&f.length>0},itH=async function(f,e){if(e.length===0)return[];
const B=e.map(r=>g.pe(r,"transfer")),n=(await gm(f.C,"transfer",B)).filter(Hrg).map(r=>g.aJ(r.key).entityId);
f=e.filter(r=>n.indexOf(r)===-1);
if(f.length===0)return[];for(const r of f)await hy(r);return f},BpF=async function(f,e,B,n,r,L){let d="STREAM_TYPE_UNKNOWN";
B.video&&B.audio?(d="STREAM_TYPE_AUDIO_AND_VIDEO",Qi("unexpected stream type")):B.video&&!B.audio?d="STREAM_TYPE_VIDEO":!B.video&&B.audio&&(d="STREAM_TYPE_AUDIO");const t=g.pe(e,"offlineVideoStreams"),H={numBytesDownloaded:r.toFixed(),numTotalBytes:L.toFixed(),streamType:d,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(n),itag:d==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(B.itag):void 0};await mp(f,{mode:"readwrite",XG:!0},k=>{const C=Ax(k,t,"offlineVideoStreams"),w=Ax(k,
g.pe(e,"transfer"),"transfer");return g.FD.all([C,w]).then(([v,b])=>{if(!b)return u3(k,t).then(()=>{});
var K=fdL(v);v=e7L(v,n,H,t);const Y=Vi(k,v,"offlineVideoStreams");fdL(v)>K&&(b.lastProgressTimeMs=Date.now().toString());K=[Y];b.offlineVideoStreams||(b.offlineVideoStreams=[]);b.offlineVideoStreams.indexOf(t)===-1&&(b.offlineVideoStreams.push(t),K.push(Vi(k,b,"transfer")));return g.FD.all(K)})})},nYx=async function(f,e){e=g.pe(e,"offlineVideoStreams");
if((e=await hx(f,e,"offlineVideoStreams"))&&e.streamsProgress){for(const B of e.streamsProgress)B.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",B.numTotalBytes!==B.numBytesDownloaded&&(B.numBytesDownloaded=B.numTotalBytes);await UJ(f,e,"offlineVideoStreams")}},e7L=function(f,e,B,n){if(f&&f.streamsProgress){n=f;
a:{e=`${e.itag};${e.xtags}`;var r=f.streamsProgress;for(let L=0;L<r.length;L++){const d=JSON.parse(r[L].formatStreamBytes);if(`${d.itag};${d.xtags}`===e){r[L]=B;B=r;break a}}r.push(B);B=r}n.streamsProgress=B}else f={key:n,streamsProgress:[B]};return f},fdL=function(f){if(f?.streamsProgress){let e=0;
f=f.streamsProgress;for(let B=0;B<f.length;B++){const n=f[B];isNaN(Number(n.numBytesDownloaded))?Qi("stream progress bytes number invalid"):e+=Number(n.numBytesDownloaded)}return e}return 0},OtT=async function(f){if(f.C){const e=f.C;
f.V.stop();await Dn(f,"TRANSFER_STATE_PAUSED_BY_USER");const B=e?.key?g.aJ(e.key).entityId:"";B&&f.J&&await BC(B,f.J,f.G,"DOWNLOAD_STATE_PAUSED");const n=await Jy(f,B);NjF({videoId:B,RJ:e,offlineModeType:n})}else M0(f,"onTransferPausedByUser");GA(f);xS(f)},olM=async function(f){if(f.C){f.V.stop();
await Dn(f,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var e=f.C;(e=e?.key?g.aJ(e.key).entityId:"")&&f.J&&await BC(e,f.J,f.G,"DOWNLOAD_STATE_PAUSED");GA(f)}else M0(f,"onTransferPausedByNetwork")},WC=async function(f){if(f.C){f.V.start(108E5);
await Dn(f,"TRANSFER_STATE_TRANSFERRING");var e=f.C;(e=e?.key?g.aJ(e.key).entityId:"")&&f.J&&await BC(e,f.J,f.G,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else M0(f,"onTransferStart")},rRu=async function(f,e,B){if(f.C){f.C.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await WC(f);
var n=Date.now();n-f.eI>1E3&&(f.eI=n,await BpF(f.G,B.videoId,B.G,B.kt,B.bytesDownloaded,B.C),!f.N||f.N&&n-f.Ed>f.BS)&&(f.Ed=n,n=await Jy(f,e),U7e({videoId:e,RJ:f.C,offlineModeType:n},B.bytesDownloaded,B.C));f.V.start(108E5)}else M0(f,`onTransferProgress: ${e}`)},dne=async function(f){if(f.C){var e=f.C;
f.V.stop();if(e&&f.W){var B=ty(f.api.S(),e.cotn,f.W);await LDB(f,B)}await Dn(f,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(B=e?.key?g.aJ(e.key).entityId:"")&&f.J&&await BC(B,f.J,f.G,"DOWNLOAD_STATE_COMPLETE");await nYx(f.G,B);var n=await Jy(f,B);I9({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:B,RJ:e,offlineModeType:n});GA(f);xS(f)}else M0(f,"onTransferComplete")},tvu=async function(f){await wre();
f=f.cS;var e=g.Sc();e=Object.keys(e);await itH(f,e)},CTM=async function(f){f=(await gm(f.G,"transfer")).filter(HO2).sort(kP2);
return f.length===0?void 0:f[0]},bOx=async function(f,e){if(!f.K){f.K=!0;
f.C=e;var B=g.aJ(f.C.key).entityId;if(f.C.transferState==="TRANSFER_STATE_TRANSFERRING"){var n=await Jy(f,B);I9({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:B,RJ:f.C,offlineModeType:n})}else f.C.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||f.C.transferRetryCount||f.C.hasLoggedFirstStarted||(n=await Jy(f,B),f.C.hasLoggedFirstStarted=!0,await wXI(f),U7e({videoId:B,RJ:f.C,offlineModeType:n},void 0,void 0,!0));await WC(f);B=null;try{B=await vYg(f,
e),f.W=B}catch(r){Qi("error getting player response",r,e.cotn);await f.Kk("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}n=ty(f.api.S(),e.cotn,B);await LDB(f,n);n.KG=await jDe(n.videoId);B=f.X;e=e.maximumDownloadQuality;n.getPlayerResponse();g.Qm(n.videoId,2);B.J=2;B.G=!1;B.player?.dispose();B.player=B.api.DK(n);B.player.V_({localmediachange:B.ww,signatureexpired:B.Pc,statechange:B.V},B);B.Y("html5_generate_content_po_token")&&B.player.Zm();e=B.TO(e);B.player.mJ(g.ig(e,e,!0,"m"),!1);B.player.Qg(!1);
f.V.start(108E5)}},GA=function(f){f.C=void 0;
f.W=void 0;f.V.stop()},xS=async function(f,e=!1){if(f.C)throw Error("Already downloading a video");
f.Ed=0;f.K=!1;const B=await CTM(f);m7x(f.uY,!B);B&&f.U.rZ()?(e&&await new Promise(n=>{g.VY(n,1E3)}),await bOx(f,B)):!B&&f.C&&GA(f)},Jy=async function(f,e){return(await hx(f.G,g.pe(e,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},ZOV=async function(f){f.W&&(await g3(f.X,f.W.videoDetails.videoId),GA(f))},LDB=async function(f,e){try{(e.captionTracks.length||e.Yp)&&!await $Sx(e.videoId)&&await IgV(f.Fl,e)}catch(B){Qi("Caption downloading error",B,e.cotn)}},wXI=
async function(f,e){if(f.C){var B=f.C;
await mp(f.G,{mode:"readwrite",XG:!0},n=>{const r=[Vi(n,B,"transfer")];e&&r.push(e(n));return g.FD.all(r)})}},vYg=async function(f,e){e=g.aJ(e.key).entityId;
e=g.pe(e,"playbackData");f=await hx(f.G,e,"playbackData");if(f?.playerResponseJson)return JSON.parse(f.playerResponseJson);throw Error("No PlayerResponse found");},Dn=async function(f,e,B,n){if(f.C){f.C.transferState=e;
f.C.failureReason=n;try{await wXI(f,r=>B?jn(r,"offlineVideoStreams",f.C.offlineVideoStreams).then(L=>{for(const d of L)if(d&&d.streamsProgress)for(const t of d.streamsProgress)t.streamState=B;return l3(r,L.filter(d=>!!d),"offlineVideoStreams")}):g.FD.resolve(void 0))}catch(r){r instanceof g.OU&&r.type==="QUOTA_EXCEEDED"&&await f.Kk("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else M0(f,`saveTransferState: ${e}`)},M0=function(f,e){f.api.ri("woffle",{mcte:e});
Qi("missing current transfer entity.")},R7B=function(f){const e=(f.C.transferRetryCount||0)<3;
e&&(f=f.C,f.transferRetryCount=(f.transferRetryCount||0)+1);return e},KDV=async function(f,e="TRANSFER_FAILURE_REASON_UNKNOWN"){f.C||M0(f,`setTransferToFailed: ${e}`);
var B="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";e==="TRANSFER_FAILURE_REASON_NETWORK"?B="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":e==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(B="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await Dn(f,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",e);XE(f.A,{entityKey:f.C?.key,failureReason:B});B=f.C?g.aJ(f.C.key).entityId:"";const n=await Jy(f,B);f={videoId:B,RJ:f.C,offlineModeType:n};B={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};e&&(B.transferFailureReason=e,B.failureReason=hBe(e));I9(B,f)},HO2=function(f){return s9[f.transferState]!==void 0},kP2=function(f,e){const B=s9[f.transferState],n=s9[e.transferState];
return B!==n?B-n:Number(f.enqueuedTimestampMs)-Number(e.enqueuedTimestampMs)},qOT=async function(f){g.yW(f.api,"onOrchestrationBecameLeader");
await f.vO()},pX2=async function(f){const e=await EJ();
if(e){f.G=new z7B(e,f.api,f.J,f.C);var B=f.U(e);f.K=await DST(e,B,f.J,f.C,f.Ta);await adV(f)}else Qi("PES is undefined")},adV=async function(f){if(f.G){f.G.C||await xS(f.G);
f.Ta.Y("woffle_enable_main_downloads_library")&&await f.WS();f.Ta.Y("html5_offline_playback_position_sync")&&(await f.eI(),await f.PU(864E5));await f.refreshAllStaleEntities(43200,!0);await f.N();f.Ta.Y("html5_retry_downloads_for_expiration")&&await f.BI();f.Ed=g.ls(()=>{f.refreshAllStaleEntities(43200,!0);f.N()},9E5);
g.wS(g.bo(),()=>f.KP());
var e=await EJ();await VxL(e);uyT(f.J)}else Qi("transferManager is undefined")},cRL=async function(){const f=await EJ();
if(!f)return[];const e=Date.now()/1E3,B=await gm(f,"offlineVideoPolicy");for(const n of B)n.expirationTimestamp&&Number(n.expirationTimestamp)<e&&(n.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",n.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await UJ(f,n,"offlineVideoPolicy"));return B.map(n=>n.key)},Xr=async function(f,e,B,n,r){var L=await EJ();
if(!L)return[];e=e.map(d=>{var t=g.pe(d,B);t={actionType:n,entityKey:t,actionMetadata:{...HC(),...r}};n!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(t.actionMetadata.priority=0);d=new kS(B,d,t);return w3(d)});
L=iuL(L,e);l3e(f.J);return L},YOH=async function(f,e,B,n){const r=[];
for(const L of e)if(!L.upToDate&&(!B||L.shouldAutoSyncMetadata)&&L.playlistId){e={};switch(n){case "mainPlaylistEntity":e={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:L.checkInSeconds,autoSync:B}};break;case "musicPlaylist":e={musicPlaylistEntityActionMetadata:{autoSync:B}}}(e=await Xr(f,[L.playlistId],n,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",e))&&r.push(...e)}return r},ARI=async function(f,e){if(e.length){const B=HC();
g.mj(B,Fr,{isEnqueuedForExpiredStreamUrlRefetch:!0});f.api.ri("qrd",{v:e.length});return Xr(f,e,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",B)}return[]},OOF=async function(f,e){const B=$o(e);
var n=g.aJ(e.entityKey).entityId;let r=[];try{r=await j1u(f,n),f.Ta.Y("woffle_enable_main_downloads_library")&&r?.length&&await ai(f.C,[e.entityKey])}catch(d){return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",d instanceof g.OU&&d.type==="QUOTA_EXCEEDED"?(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):Qi("Playlist add error"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
B,void 0,e,n)}const L=[];f.Ta.Y("html5_offline_prevent_redownload_downloaded_video")&&(r=await d3(f.C,"mainVideoEntity",r));if(r?.length)for(const d of r)f=d.offlineVideoData,f?.videoId&&L.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",f.videoId,"mainVideoEntity",Number(e.actionMetadata?.priority||0)+1,yu,PC(e,f,n)));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,L)},VvF=async function(f,e){const B=$o(e);
var n=e.entityKey,r=g.aJ(n).entityId,L=[],d=!1;r==="!*$_ALL_ENTITIES_!*$"?(d=!0,L=await gm(f.C,"mainPlaylistEntity")):(n=await hx(f.C,n,"mainPlaylistEntity"))&&L.push(n);if(!L?.length)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);var t=g.u(e.actionMetadata,oYI);n=t?.nextAutoRefreshIntervalSeconds;const H=t?.autoSync;let k=[],C=!0;t=!0;let w=!1;if(d||H!==!1){try{k=await r8F(0,!!H,!0,L)}catch(Y){Y instanceof Error&&Y.message==="No data"?r==="!*$_ALL_ENTITIES_!*$"?await Kc(f.C,e,f.J,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await Ri(r,f.C,e,f.J):Y instanceof Error&&Y.message==="Empty response body"&&Qi(Y.message)}if(!k.length||!d&&k[0].playlistId!==r)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)}if(d){e=[];for(var v of k)v.upToDate||H&&!v.shouldAutoSyncMetadata||!v.playlistId||e.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v.playlistId,"mainPlaylistEntity",0,yu,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:v.checkInSeconds,autoSync:H}}));
return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,e)}k.length&&(v=k[0],w=!!v.upToDate,H&&(C=v.shouldAutoSyncMetadata??!0,t=v.shouldAutoSyncVideos??!0,v.checkInSeconds&&(n=v.checkInSeconds)));if(w||!C)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);v=[];L=L[0];d=L.downloadState?await hx(f.C,L.downloadState,"mainPlaylistDownloadStateEntity"):void 0;d=d?.addedTimestampMillis?String(d.addedTimestampMillis):void 0;try{v=await j1u(f,r,d,n)}catch(Y){if(Y instanceof Error&&Y.message===
"No data for playlist")await Ri(r,f.C,e,f.J);else if(Y instanceof Error&&Y.message==="Empty response body for playlist")Qi(Y.message);else return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",r="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",Y instanceof g.OU&&Y.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",r="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,e,r)}if(!t)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
B);f=[];n=new Map;if(v?.length)for(var b of v)t=b.offlineVideoData,t?.videoId&&n.set(t.videoId,t);b=new Map;t=[];if(L?.videos?.length)for(var K of L.videos)if(L=JSON.parse(g.aJ(K).entityId).videoId)n.has(L)?(b.set(L,n.get(L)),n.delete(L)):t.push(L);K=Number(e.actionMetadata?.priority||0)+1;for(const [Y,l]of n.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",Y,"mainVideoEntity",K,yu,PC(e,l,r)));for(const [Y,l]of b.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",Y,"mainVideoEntity",
K,yu,PC(e,l,r)));for(const Y of t)f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",Y,"mainVideoEntity",0,yu,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:r}}));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,f)},ldL=async function(f,e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;n==="!*$_ALL_ENTITIES_!*$"?await Kc(f.C,e,f.J,e.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await Ri(n,f.C,e,f.J),f.Ta.Y("woffle_enable_main_downloads_library")&&await pc(f.C,e.entityKey))}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
B)},j1u=async function(f,e,B,n){e=await l9([e]);
const {mainPlaylistEntity:r,CO:L}=await uaB(f,e[0],B,n);f=Tjx(r,L?.avatar);try{await b9(f)}catch(d){d instanceof Error&&d.message==="Failed to fetch"&&Qi(d.message)}return e[0].videos},PC=function(f,e,B){e={offlineVideoData:e,
playlistId:B};if(f=g.u(f.actionMetadata,oYI))e.maximumDownloadQuality=f.maximumDownloadQuality;return{mainVideoEntityActionMetadata:e}},uaB=async function(f,e,B,n){const r=Date.now().toString();
B||(B=r);var L=e.videos;const d=e.playlistId,t=[],H=[];if(L)for(const v of L){L=v.offlineVideoData;if(!L||!L.videoId)throw Qi("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");L=L.videoId;L={id:g.pe(JSON.stringify({videoId:L,playlistId:d}),"mainPlaylistVideoEntity"),video:g.pe(L,"mainVideoEntity")};t.push(L);H.push(L.id)}let k;const C={key:g.pe(d,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:B,lastSyncedTimestampMillis:r},w={key:g.pe(d,"mainPlaylistEntity"),
playlistId:d,videos:H,title:e.title,thumbnailStyleData:FDL(e),visibility:mnG(e),downloadState:C.key};e.channel&&(B=e.channel.offlineChannelData,k=UnG(g.pe(d,"ytMainChannelEntity"),B),w.channelOwner=k.id);w?.entityMetadata?(w.entityMetadata.offlineLastModifiedTimestampSeconds=e.lastModifiedTimestamp,n&&(w.entityMetadata.nextAutoRefreshIntervalSeconds=String(n))):w&&(w.entityMetadata={nextAutoRefreshIntervalSeconds:n?String(n):void 0,offlineLastModifiedTimestampSeconds:e.lastModifiedTimestamp});try{await mp(f.C,
{mode:"readwrite",XG:!0},v=>{var b=Vi(v,w,"mainPlaylistEntity");const K=Vi(v,C,"mainPlaylistDownloadStateEntity");b=[b,K];for(const Y of t)b.push(Vi(v,Y,"mainPlaylistVideoEntity"));k&&b.push(Vi(v,k,"ytMainChannelEntity"));return g.FD.all(b)})}catch(v){throw Qi("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:w,CO:k,M6I:t}},FDL=function(f){const e=[];
var B=f.videos;B&&B.length>0&&e.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:B[0].offlineVideoData.thumbnail}}});if((f=f.additionalMetadadatas)&&f.length>0)for(const n of f)switch(f=n.offlineBundleItemPlaylistData,B={collageThumbnail:{coverThumbnail:f?.coverThumbnail}},f?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":e.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:B});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":e.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:B});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":e.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:B});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":e.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:B})}return e},mnG=function(f){switch(f.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},UnG=function(f,e){return{id:f,
channelId:e.channelId,title:e.title,avatar:e.thumbnail}},gYB=async function(f,e){const B=$o(e);
var n=g.aJ(e.entityKey).entityId;const r=g.u(e.actionMetadata,Ii),L=!r?.playlistId;try{await Npg(f,n,void 0,r?.offlineVideoData,L)}catch(d){return n="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",d instanceof g.OU&&d.type==="QUOTA_EXCEEDED"&&(n="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,n,e)}f=Number(e.actionMetadata?.priority||
0)+1;e=(e=g.u(e.actionMetadata,Ii))?{playbackDataActionMetadata:{maximumDownloadQuality:e.maximumDownloadQuality}}:void 0;n=u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",n,"playbackData",f,h7e,e);return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,[n])},SOe=async function(f,e){const B=$o(e),n=g.aJ(e.entityKey).entityId;
var r=await hx(f.C,e.entityKey,"mainVideoEntity"),L=r?await hx(f.C,r.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!r||!L)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);let d;try{await Npg(f,n,L.addedTimestampMillis,g.u(e.actionMetadata,Ii)?.offlineVideoData),r=1,r=Number(e.actionMetadata?.priority||0)+1,d=u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",n,"playbackData",r,h7e)}catch(t){if(t instanceof Error&&t.message==="No data"){r=await cC(f.C,n);if(L=g.u(e.actionMetadata,
Ii)?.playlistId)r.playlistId=L;r.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await Zn(n,f.C,e,f.J,r)}else if(t instanceof Error&&t.message==="Empty response body")Qi(t.message);else return f="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",t instanceof g.OU&&t.type==="QUOTA_EXCEEDED"&&(f="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
B,void 0,f,e)}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,d?[d]:void 0)},EYV=async function(f,e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;if(n==="!*$_ALL_ENTITIES_!*$")await Kc(f.C,e,f.J,e.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const r=await cC(f.C,n),L=g.u(e.actionMetadata,Ii)?.playlistId;L&&(r.playlistId=L);r.offlineDeleteReason=e.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await Zn(n,f.C,e,f.J,r);f.Ta.Y("woffle_enable_main_downloads_library")&&await pc(f.C,e.entityKey)}}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},Npg=async function(f,e,B,n,r){n||(n=(await Bfe([e]))[0]);
const {mainVideoEntity:L,channelEntity:d}=await Q1M(f,n,B,r);try{const t=Lc(L.thumbnail),H=Lc(d.avatar);await b9(t.concat(H))}catch(t){t instanceof Error&&t.message==="Failed to fetch"&&Qi(t.message)}},Q1M=async function(f,e,B,n){B||(B=Date.now().toString());
const r=e.channel?.offlineChannelData,L={id:g.pe(e.videoId,"ytMainChannelEntity"),channelId:r.channelId,title:r.title,avatar:r.thumbnail},d={key:g.pe(e.videoId,"mainVideoDownloadStateEntity"),playbackData:g.pe(e.videoId,"playbackData"),addedTimestampMillis:B,videoDownloadContextEntity:g.pe(e.videoId,"videoDownloadContextEntity")},t={key:g.pe(e.videoId,"videoPlaybackPositionEntity"),videoId:e.videoId,lastPlaybackPositionSeconds:"0"};let H;f.Ta.Y("html5_offline_playback_position_sync")&&(H={playbackPosition:t.key});
B=g.pe(e.videoId,"mainVideoEntity");const k={key:B,videoId:e.videoId,title:e.title,thumbnail:e.thumbnail,localizedStrings:{viewCount:e.shortViewCountText},userState:H,lengthSeconds:e.lengthSeconds?Number(e.lengthSeconds):void 0,publishedTimestampMillis:e.publishedTimestamp?(Number(e.publishedTimestamp)*1E3).toString():void 0,formattedDescription:e.description,owner:L.id,downloadState:d.key};let C,w;f.Ta.Y("woffle_enable_main_downloads_library")&&n&&(n=await Xrx(f.C,[B]))&&(C=n.mainDownloadsLibraryEntity,
w=n.mainDownloadsListEntity);let v;v={key:g.pe(e.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.mj(d,SlI,v);await mp(f.C,{mode:"readwrite",XG:!0},b=>{var K=Vi(b,L,"ytMainChannelEntity"),Y=Vi(b,d,"mainVideoDownloadStateEntity");const l=Vi(b,k,"mainVideoEntity");K=[K,Y,l];f.Ta.Y("html5_offline_playback_position_sync")&&(Y=Vi(b,t,"videoPlaybackPositionEntity"),K.push(Y));C&&(Y=Vi(b,C,"mainDownloadsLibraryEntity"),K.push(Y));w&&(Y=Vi(b,w,"mainDownloadsListEntity"),
K.push(Y));v&&(b=Vi(b,v,"downloadStatusEntity"),K.push(b));return g.FD.all(K)});
return{mainVideoEntity:k,channelEntity:L}},DnI=async function(f,e){const B=$o(e),n=[];
var r=await N0.getInstance();let L,d;r&&(L=await r.get("sdois"),d=await r?.get("lmqf"));try{if(L===void 0)throw Error("prefStorage or opt-in state is undefined");r=[];L||(r=await sQI(f.C),r.reverse());if(r.length)for(const k of r){if(!k)continue;const C=g.aJ(k).entityId,w=await cC(f.C,C);w.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await Zn(C,f.C,{entityKey:k,actionType:e.actionType},f.J,w)}const t=await dSF(L,d??"SD");await Mxe(t);const H=W7B(t);f.Ta.Y("woffle_enable_main_downloads_library")&&
(L||await pc(f.C,zA),await ai(f.C,[zA]));if(H?.length)for(const k of H){const C=k.actionType,w=k.entityKey,v=k.actionMetadata;if(C&&w&&v&&!g.u(v,TpL)){C==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(v.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const b=g.u(k.actionMetadata,Ii);b&&(b.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",k.actionMetadata={...k.actionMetadata,mainVideoEntityActionMetadata:b});n.push(k)}}}catch(t){return f="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
e="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",t instanceof g.OU&&t.type==="QUOTA_EXCEEDED"&&(f="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,f,e)}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,n)},JRV=async function(f,e=43200,B=!0){if(!f.X.rZ())return[];
let n=[];try{n=await r8F(e,B,!1)}catch(r){r instanceof Error&&r.message==="No data"||r instanceof Error&&r.message==="Empty response body"&&Qi(r.message)}return YOH(f,n,B,"mainPlaylistEntity")},Mve=async function(f,e,B,n=!1){let r=[];
if(!await L2I()&&!n)return[];B=await tmI(e,B);if(!B?.length)return[];e={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const d of B){B=d.actionType;var L=d.entityKey;n=d.actionMetadata;B&&L&&n&&!g.u(n,TpL)&&(B==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(n.offlineLoggingData=e),{entityId:L}=g.aJ(L),B=await Xr(f,[L],"mainVideoEntity",B,n),r=r.concat(B))}return r},xng=async function(f,e){const B=$o(e);
var n=g.aJ(e.entityKey).entityId;let r=[];try{r=await GPI(f,n),r?.length&&await O9(f.C,e.entityKey)}catch(d){return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",d instanceof g.OU&&d.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,e,n)}const L=[];r=await d3(f.C,"musicTrack",r);if(r.length)for(const d of r)f=
d.offlineVideoData,f?.videoId&&L.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",f.videoId,"musicTrack",Number(e.actionMetadata?.priority||0)+1,$S,Vu(e,f,n)));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,L)},WDx=async function(f,e){const B=$o(e);
var n=e.entityKey,r=g.aJ(n).entityId,L=[],d=!1;r==="!*$_ALL_ENTITIES_!*$"?(d=!0,L=await gm(f.C,"musicAlbumRelease")):(n=await hx(f.C,n,"musicAlbumRelease"))&&L.push(n);if(!L?.length)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);if(d){e=[];for(var t of L){var H=g.aJ(t.id).entityId;e.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",H,"musicAlbumRelease",0,$S))}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,e)}t=[];L=L[0];d=void 0;L.downloadMetadata&&(d=await hx(f.C,
L.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),d=Number(d?.addedTimestampMillis??"0")/1E3);try{t=await GPI(f,r,d?.toString())}catch(w){if(w instanceof Error&&w.message==="No data")await Ay(r,"musicAlbumRelease",f.C,e,f.J);else if(w instanceof Error&&w.message==="Empty response body")Qi(w.message);else return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",H="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.OU&&w.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
H="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,e,H)}f=[];r=new Map;if(t?.length)for(var k of t)t=k.offlineVideoData,t?.videoId&&r.set(t.videoId,t);k=new Map;t=[];if(L?.tracks?.length)for(var C of L.tracks)if(L=g.aJ(C).entityId)r.has(L)?(k.set(L,r.get(L)),r.delete(L)):t.push(L);C=Number(e.actionMetadata?.priority||0)+1;for(const [w,v]of r.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",w,"musicTrack",C,$S,Vu(e,v)));for(const [w,
v]of k.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",w,"musicTrack",C,$S,Vu(e,v)));for(H of t)f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",H,"musicTrack",0,$S));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,f)},s12=async function(f,e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;n==="!*$_ALL_ENTITIES_!*$"?await j0(f.C,e,f.J):(await Ay(n,"musicAlbumRelease",f.C,e,f.J),await oi(f.C,e.entityKey))}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},GPI=async function(f,e,B){e=await l9([e]);
f=await XXG(f,e[0],B);f=Lc(f.thumbnailDetails);await b9(f);return e[0].videos},XXG=async function(f,e,B){var n=e.additionalMetadadatas;
let r=void 0;if(n&&n.length>0)for(var L of n)if(L.offlineMusicPlaylistData){r=L.offlineMusicPlaylistData;break}n=e.playlistId;const {vG:d,Jn:t}=irB(e);B=B?(Number(B)*1E3).toString():Date.now().toString();L=e.lastModifiedTimestamp?(Number(e.lastModifiedTimestamp)*1E3).toString():"0";const H={id:g.pe(n,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:t,lastModifiedTimestampMillis:L,addedTimestampMillis:B,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},k={id:g.pe(n,"musicAlbumRelease"),
title:e.title,audioPlaylistId:n,trackCount:e.totalVideoCount,tracks:d,downloadMetadata:H.id};r&&(k.thumbnailDetails=r.albumHqThumbnail??r.albumArtistThumbnail,k.artistDisplayName=r.albumArtistDisplayName,k.releaseDate=r.albumReleaseDate,k.contentRating={explicitType:r.albumReleaseExplicitType},k.releaseType=r.albumReleaseType);await mp(f.C,{mode:"readwrite",XG:!0},C=>{const w=Vi(C,k,"musicAlbumRelease");C=Vi(C,H,"musicAlbumReleaseDownloadMetadataEntity");return g.FD.all([w,C])});
return k},PTH=async function(f,e){const B=$o(e);
var n=g.aJ(e.entityKey).entityId;let r=[];try{r=await yRV(f,n),r?.length&&await O9(f.C,e.entityKey)}catch(d){return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",d instanceof g.OU&&d.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,e,n)}const L=[];r=await d3(f.C,"musicTrack",r);if(r.length)for(const d of r)f=
d.offlineVideoData,f?.videoId&&L.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",f.videoId,"musicTrack",Number(e.actionMetadata?.priority||0)+1,i9,Vu(e,f,n)));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,L)},Ide=async function(f,e){const B=$o(e);
var n=e.entityKey,r=g.aJ(n).entityId,L=[],d=!1;r==="!*$_ALL_ENTITIES_!*$"?(d=!0,L=await gm(f.C,"musicPlaylist")):(n=await hx(f.C,n,"musicPlaylist"))&&L.push(n);if(!L?.length)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);const t=g.u(e.actionMetadata,fgB)?.autoSync;let H=[],k=!0;n=!0;let C=!1;var w=void 0;if(d||t!==!1){try{H=await HtB(0,!!t,!0,L)}catch(l){l instanceof Error&&l.message==="No data"?r==="!*$_ALL_ENTITIES_!*$"?await j0(f.C,e,f.J):await Ay(r,"musicPlaylist",f.C,e,f.J):l instanceof
Error&&l.message==="Empty response body"&&Qi(l.message)}if(!H.length||!d&&H[0].playlistId!==r)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)}if(d){e=[];for(var v of H)v.upToDate||t&&!v.shouldAutoSyncMetadata||!v.playlistId||e.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v.playlistId,"musicPlaylist",0,i9,{musicPlaylistEntityActionMetadata:{autoSync:t}}));return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,e)}H.length&&(v=H[0],C=!!v.upToDate,t&&(k=v.shouldAutoSyncMetadata??
!0,n=v.shouldAutoSyncVideos??!0,v.checkInSeconds&&(w=v.checkInSeconds)));if(C||!k)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);v=[];L=L[0];d=void 0;L.downloadMetadata&&(d=await hx(f.C,L.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),d=Number(d?.addedTimestampMillis??"0")/1E3);try{v=await yRV(f,r,d?.toString(),w)}catch(l){if(l instanceof Error&&l.message==="No data")await Ay(r,"musicPlaylist",f.C,e,f.J);else if(l instanceof Error&&l.message==="Empty response body")Qi(l.message);
else{e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var b="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";l instanceof g.OU&&l.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",b="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,e,b)}}if(!n)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);f=[];r=new Map;if(v?.length)for(var K of v)n=K.offlineVideoData,n?.videoId&&
r.set(n.videoId,n);K=new Map;n=[];if(L?.tracks?.length)for(var Y of L.tracks)if(w=g.aJ(Y).entityId)r.has(w)?(K.set(w,r.get(w)),r.delete(w)):n.push(w);Y=Number(e.actionMetadata?.priority||0)+1;for(const [l,m]of r.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",l,"musicTrack",Y,i9,Vu(e,m)));for(const [l,m]of K.entries())f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",l,"musicTrack",Y,i9,Vu(e,m)));for(b of n)f.push(u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",b,"musicTrack",0,i9));
return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,f)},$nL=async function(f,e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;n==="!*$_ALL_ENTITIES_!*$"?await j0(f.C,e,f.J):(await Ay(n,"musicPlaylist",f.C,e,f.J),await oi(f.C,e.entityKey))}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},yRV=async function(f,e,B,n){e=await l9([e]);
f=await iOV(f,e[0],B,n);f=Lc(f.thumbnailDetails);await b9(f);return e[0].videos},iOV=async function(f,e,B,n){const r=e.playlistId,{vG:L,
Jn:d}=irB(e);B=B?(Number(B)*1E3).toString():Date.now().toString();const t=e.lastModifiedTimestamp?(Number(e.lastModifiedTimestamp)*1E3).toString():"0",H={id:g.pe(r,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:d,lastModifiedTimestampMillis:t,addedTimestampMillis:B,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},k={id:g.pe(r,"musicPlaylist"),title:e.title,playlistId:r,thumbnailDetails:e.thumbnail,visibility:feL(e),trackCount:e.totalVideoCount,tracks:L,downloadMetadata:H.id};n&&(k?.entityMetadata?
k.entityMetadata.nextAutoRefreshIntervalSeconds=String(n):k&&(k.entityMetadata={nextAutoRefreshIntervalSeconds:String(n)}));await mp(f.C,{mode:"readwrite",XG:!0},C=>{const w=Vi(C,k,"musicPlaylist");C=Vi(C,H,"musicPlaylistDownloadMetadataEntity");return g.FD.all([w,C])});
return k},feL=function(f){switch(f.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},n0H=async function(f,e){const B=$o(e);
var n=g.aJ(e.entityKey).entityId;const r=g.u(e.actionMetadata,fW);try{await eCB(f,n,void 0,r?.track,r?.albumRelease),r?.playlistId||await O9(f.C,e.entityKey)}catch(L){return e="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.OU&&L.type==="QUOTA_EXCEEDED"&&(e="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,
void 0,e,n)}f=(f=g.u(e.actionMetadata,fW))?{playbackDataActionMetadata:{maximumDownloadQuality:f.maximumDownloadQuality}}:void 0;e=u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",n,"playbackData",Number(e.actionMetadata?.priority||0)+1,Bee,f);return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,[e])},rDB=async function(f,e){const B=$o(e),n=g.aJ(e.entityKey).entityId;
var r=await hx(f.C,e.entityKey,"musicTrack");const L=r?await hx(f.C,r.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!r||!L)return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B);let d;r=g.u(e.actionMetadata,fW);try{await eCB(f,n,L.addedTimestampMillis,r?.track,r?.albumRelease),d=u9("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",n,"playbackData",Number(e.actionMetadata?.priority||0)+1,Bee)}catch(t){if(t instanceof Error&&t.message==="No data")await YS(n,f.C,e,f.J);else if(t instanceof
Error&&t.message==="Empty response body")Qi(t.message);else return f="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",t instanceof g.OU&&t.type==="QUOTA_EXCEEDED"&&(f="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",e="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,f,e)}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B,d?[d]:void 0)},LbM=async function(f,
e){const B=$o(e);
try{const n=g.aJ(e.entityKey).entityId;n==="!*$_ALL_ENTITIES_!*$"?await j0(f.C,e,f.J):(await YS(n,f.C,e,f.J),await oi(f.C,e.entityKey))}catch(n){return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",B,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new U9("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",B)},eCB=async function(f,e,B,n,r){n||(n=(await Bfe([e]))[0],n=$7T(n));
const {musicTrackEntity:L,w1:d}=await dfe(f,n,e,r,B);f=Lc(L.thumbnailDetails);e=[];d&&(e=Lc(d.thumbnailDetails));await b9(f.concat(e))},dfe=async function(f,e,B,n,r){r||(r=Date.now().toString());
const L={id:g.pe(B,"musicTrackDownloadMetadataEntity"),playbackData:g.pe(B,"playbackData"),addedTimestampMillis:r,videoDownloadContextEntity:g.pe(B,"videoDownloadContextEntity")};n&&(e.albumRelease=n.id);await mp(f.C,{mode:"readwrite",XG:!0},d=>{const t=[];var H=Vi(d,L,"musicTrackDownloadMetadataEntity");t.push(H);H=Vi(d,e,"musicTrack");t.push(H);n&&(d=Vi(d,n,"musicAlbumRelease"),t.push(d));return g.FD.all(t)});
await BC(B,"musicTrackDownloadMetadataEntity",f.C,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:e,w1:n}},tIF=async function(f,e=43200,B=!0){if(!f.X.rZ())return[];
let n=[];try{n=await HtB(e,B,!1)}catch(r){}return YOH(f,n,B,"musicPlaylist")},HYH=function(f){let e;
f=g.u(f.getWatchNextResponse()?.currentVideoEndpoint,g.iK);f?.playlistId&&(e=f.playlistId);return e},kDT=async function(f,e){const B=e.clientPlaybackNonce,n={cpn:B,
offlineSourceVisualElement:g.kv(e.A||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};e.G&&(n.videoFmt=Number(e.G.itag));e.V&&(n.audioFmt=Number(e.V.itag));const r=HYH(e);var L;if(L=r&&e.videoId)e=e.videoId,L=await (r!=="PPSV"?Promise.resolve(!1):f.C.cS(e));L&&(n.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");f.G=B;g.t$("offlinePlaybackStarted",n)};
g.sL.prototype.DK=g.B5(42,function(f){return this.app.DK(f)});
g.S6.prototype.DK=g.B5(41,function(f){return g.BIG(this,9,f)});
var eP=class{constructor(f){this.C=f}},Bv=class extends eP{get entityMetadata(){return this.C.entityMetadata}set entityMetadata(f){this.C.entityMetadata=f}},CUe=class extends eP{G(){const f=[];this.C.video&&f.push(this.C.video);return[...(new Set(f))]}},wTH=class extends eP{G(){const f=[];this.C.video&&f.push(this.C.video);this.C.playlist&&f.push(this.C.playlist);this.C.videoItem&&f.push(this.C.videoItem);this.C.playlistItem&&f.push(this.C.playlistItem);return[...(new Set(f))]}},v0V=class extends eP{G(){const f=
[];this.C.localImageEntities&&f.push(...this.C.localImageEntities);this.C.videoDownloadContextEntity&&f.push(this.C.videoDownloadContextEntity);return[...(new Set(f))]}},bY2=class extends eP{G(){const f=[];this.C.recommendedVideoMetadata&&f.push(...(new v0V(this.C.recommendedVideoMetadata)).G());return[...(new Set(f))]}},ZYx=class extends eP{G(){const f=[];this.C.playbackPosition&&f.push(this.C.playbackPosition);return[...(new Set(f))]}},RCB=class extends eP{G(){const f=[];this.C.creatorEntity&&f.push(this.C.creatorEntity);
return[...(new Set(f))]}},k72=["browse","music/browse","streaming_browse","unplugged/browse"],vl2=["offline/playlist_sync_check"],ekF=["offline"],ChV=["offline/offline_video_playback_position_sync"],L7u=["offline/get_playback_data_entity"],N0=class{constructor(f){this.token=f}static async getInstance(){return new Promise(f=>{g.f8().then(e=>{e?(N0.instance||(N0.instance=new N0(e)),f(N0.instance)):f(void 0)})})}async get(f){if(f=await (await Ko(this.token)).get("prefs",f)){var e=(0,g.T)();
return f.expirationTimestampMs<=e?void 0:f.value}}async set(f,e,B=31536E3){const n=(0,g.T)();f={key:f,value:e,expirationTimestampMs:n+B*1E3};await (await Ko(this.token)).put("prefs",f)}async remove(f){await (await Ko(this.token)).delete("prefs",f)}},zQ,KbM={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
a9=class extends g.Dj{constructor(f,e={}){super(KbM[f],{name:"PESEncoderError",type:f,...e});this.type=f;this.level="WARNING";Object.setPrototypeOf(this,a9.prototype)}},qzG=class{},zCM=class extends qzG{constructor(f){super();this.C=f}J(f,e){e=po(e);f=(new TextEncoder).encode(JSON.stringify(f));return this.C.encrypt(f,e)}G(f,e){if(!(f instanceof Uint8Array))throw new a9("WRONG_DATA_TYPE",{hT:1});const B=new TextDecoder;e=po(e);f=this.C.decrypt(f,e);return JSON.parse(B.decode(f))}},GdB={accountLinkStatusEntity:class extends Bv{G(){return[]}},
booleanEntity:class extends Bv{G(){return[]}},buttonEntity:class extends Bv{G(){return[]}},captionTrack:class extends Bv{G(){return[]}},channelHandle:class extends Bv{G(){return[]}},chatLoadingStateEntity:class extends Bv{G(){return[]}},chipEntity:class extends Bv{G(){return[]}},commerceAcquisitionClientPayloadEntity:class extends Bv{G(){return[]}},commerceCartListEntity:class extends Bv{G(){return[]}},compositeSourceEntity:class extends Bv{G(){return[]}},multiviewStagingEntity:class extends Bv{G(){const f=
[];this.C.compositeSourceKeys&&f.push(...this.C.compositeSourceKeys);return[...(new Set(f))]}},contextNoteFeedEntityPayload:class extends Bv{G(){return[]}},contextNoteUserRatingEntityPayload:class extends Bv{G(){return[]}},continuationTokenEntity:class extends Bv{G(){return[]}},downloadQualityPickerEntity:class extends Bv{G(){return[]}},downloadsPageRefreshTokenEntity:class extends Bv{G(){return[]}},downloadsPageViewConfigurationEntity:class extends Bv{G(){return[]}},downloadStatusEntity:class extends Bv{G(){return[]}},
dismissState:class extends Bv{G(){return[]}},sfvAudioItemCurrentlyPlayingEntity:class extends Bv{G(){return[]}},emojiFountainDataEntity:class extends Bv{G(){return[]}},emojiCustomizationSetEntity:class extends Bv{G(){return[]}},fakeChannel:class extends Bv{G(){const f=[];this.C.alternateChannel&&f.push(this.C.alternateChannel);this.C.alternateChannelList&&f.push(...this.C.alternateChannelList);this.C.oneofChannelEntity&&f.push(this.C.oneofChannelEntity);return[...(new Set(f))]}},fakePlaylist:class extends Bv{G(){const f=
[];this.C.entryCollection&&f.push(this.C.entryCollection);return[...(new Set(f))]}},fakePlaylistEntryCollection:class extends Bv{G(){const f=[];this.C.parentPlaylist&&f.push(this.C.parentPlaylist);if(this.C.entries)for(const e of this.C.entries)f.push(...(new CUe(e)).G());return[...(new Set(f))]}},fakeVideo:class extends Bv{G(){const f=[];this.C.descriptionEntity&&f.push(this.C.descriptionEntity);this.C.creators&&f.push(...this.C.creators);this.C.theBiggestFan&&f.push(this.C.theBiggestFan);return[...(new Set(f))]}},
fakeVideoDescription:class extends Bv{G(){return[]}},featuredProductsEntity:class extends Bv{G(){return[]}},flowStateEntity:class extends Bv{G(){return[]}},iconBadgeEntity:class extends Bv{G(){return[]}},interstitialInteractionStateEntity:class extends Bv{G(){return[]}},likeButtonAnimationEntity:class extends Bv{G(){return[]}},liveChatPollStateEntity:class extends Bv{G(){return[]}},dataFreshnessEntity:class extends Bv{G(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends Bv{G(){return[]}},
liveViewerLeaderboardPointsEntity:class extends Bv{G(){return[]}},liveReactionsDataEntity:class extends Bv{G(){return[]}},logoEntity:class extends Bv{G(){return[]}},macroMarkerEntity:class extends Bv{G(){return[]}},mainDownloadsLibraryEntity:class extends Bv{G(){const f=[];this.C.downloadsList&&f.push(this.C.downloadsList);this.C.smartDownloadsList&&f.push(this.C.smartDownloadsList);this.C.recommendedDownloadsList&&f.push(this.C.recommendedDownloadsList);this.C.refresh&&f.push(this.C.refresh);return[...(new Set(f))]}},
mainDownloadsListEntity:class extends Bv{G(){const f=[];this.C.refresh&&f.push(this.C.refresh);if(this.C.downloads)for(const e of this.C.downloads)f.push(...(new wTH(e)).G());return[...(new Set(f))]}},mainPlaylistDownloadStateEntity:class extends Bv{G(){const f=[];this.C.localImageEntities&&f.push(...this.C.localImageEntities);return[...(new Set(f))]}},mainPlaylistEntity:class extends Bv{G(){const f=[];this.C.channelOwner&&f.push(this.C.channelOwner);this.C.videos&&f.push(...this.C.videos);this.C.collaboratorChannels&&
f.push(...this.C.collaboratorChannels);this.C.downloadState&&f.push(this.C.downloadState);this.C.refresh&&f.push(this.C.refresh);return[...(new Set(f))]}},mainPlaylistVideoEntity:class extends Bv{G(){const f=[];this.C.video&&f.push(this.C.video);this.C.channelContributor&&f.push(this.C.channelContributor);return[...(new Set(f))]}},mainVideoDownloadStateEntity:class extends Bv{G(){const f=[];this.C.playbackData&&f.push(this.C.playbackData);this.C.localImageEntities&&f.push(...this.C.localImageEntities);
this.C.videoDownloadContextEntity&&f.push(this.C.videoDownloadContextEntity);return[...(new Set(f))]}},mainVideoEntity:class extends Bv{G(){const f=[];this.C.owner&&f.push(this.C.owner);this.C.downloadState&&f.push(this.C.downloadState);this.C.userState&&f.push(...(new ZYx(this.C.userState)).G());this.C.additionalMetadata&&f.push(...(new bY2(this.C.additionalMetadata)).G());return[...(new Set(f))]}},markersEngagementPanelSyncEntity:class extends Bv{G(){return[]}},markersVisibilityOverrideEntity:class extends Bv{G(){return[]}},
musicAlbumReleaseDetail:class extends Bv{G(){const f=[];this.C.albumRelease&&f.push(this.C.albumRelease);this.C.tracks&&f.push(...this.C.tracks);return[...(new Set(f))]}},musicAlbumReleaseDownloadMetadataEntity:class extends Bv{G(){const f=[];this.C.trackDownloadMetadatas&&f.push(...this.C.trackDownloadMetadatas);return[...(new Set(f))]}},musicAlbumRelease:class extends Bv{G(){const f=[];this.C.musicLibraryStatusEntity&&f.push(this.C.musicLibraryStatusEntity);this.C.primaryArtists&&f.push(...this.C.primaryArtists);
this.C.details&&f.push(this.C.details);this.C.userDetails&&f.push(this.C.userDetails);this.C.tracks&&f.push(...this.C.tracks);this.C.share&&f.push(this.C.share);this.C.downloadMetadata&&f.push(this.C.downloadMetadata);this.C.refresh&&f.push(this.C.refresh);return[...(new Set(f))]}},musicAlbumReleaseUserDetail:class extends Bv{G(){const f=[];this.C.albumRelease&&f.push(this.C.albumRelease);return[...(new Set(f))]}},musicArtistDetail:class extends Bv{G(){const f=[];this.C.parentArtist&&f.push(this.C.parentArtist);
return[...(new Set(f))]}},musicArtist:class extends Bv{G(){const f=[];this.C.details&&f.push(this.C.details);this.C.userDetails&&f.push(this.C.userDetails);return[...(new Set(f))]}},musicArtistUserDetail:class extends Bv{G(){const f=[];this.C.parentArtist&&f.push(this.C.parentArtist);return[...(new Set(f))]}},musicDownloadsLibraryEntity:class extends Bv{G(){const f=[];this.C.downloadedTracks&&f.push(...this.C.downloadedTracks);this.C.smartDownloadedTracks&&f.push(...this.C.smartDownloadedTracks);
this.C.downloadedEpisodes&&f.push(...this.C.downloadedEpisodes);this.C.downloadedAlbumReleases&&f.push(...this.C.downloadedAlbumReleases);this.C.smartDownloadedAlbumReleases&&f.push(...this.C.smartDownloadedAlbumReleases);this.C.downloadedPlaylists&&f.push(...this.C.downloadedPlaylists);this.C.smartDownloadedPlaylists&&f.push(...this.C.smartDownloadedPlaylists);this.C.metadataOnlyTracks&&f.push(...this.C.metadataOnlyTracks);return[...(new Set(f))]}},musicLibraryEdit:class extends Bv{G(){return[]}},
musicLibraryStatusEntity:class extends Bv{G(){return[]}},musicPlaylist:class extends Bv{G(){const f=[];this.C.tracks&&f.push(...this.C.tracks);this.C.refresh&&f.push(this.C.refresh);this.C.musicLibraryStatusEntity&&f.push(this.C.musicLibraryStatusEntity);this.C.details&&f.push(this.C.details);this.C.downloadMetadata&&f.push(this.C.downloadMetadata);this.C.sideloadMetadata&&f.push(this.C.sideloadMetadata);this.C.userDetails&&f.push(this.C.userDetails);this.C.entryCollection&&f.push(this.C.entryCollection);
this.C.share&&f.push(this.C.share);this.C.podcastShowAdditionalMetadata&&f.push(...(new RCB(this.C.podcastShowAdditionalMetadata)).G());return[...(new Set(f))]}},musicPlaylistDownloadMetadataEntity:class extends Bv{G(){const f=[];this.C.trackDownloadMetadatas&&f.push(...this.C.trackDownloadMetadatas);return[...(new Set(f))]}},musicShare:class extends Bv{G(){return[]}},musicTrackDetail:class extends Bv{G(){const f=[];this.C.parentTrack&&f.push(this.C.parentTrack);return[...(new Set(f))]}},musicTrackDownloadMetadataEntity:class extends Bv{G(){const f=
[];this.C.playbackData&&f.push(this.C.playbackData);this.C.localImageEntities&&f.push(...this.C.localImageEntities);this.C.videoDownloadContextEntity&&f.push(this.C.videoDownloadContextEntity);return[...(new Set(f))]}},musicTrack:class extends Bv{G(){const f=[];this.C.musicLibraryStatusEntity&&f.push(this.C.musicLibraryStatusEntity);this.C.artists&&f.push(...this.C.artists);this.C.audioModeVersion&&f.push(this.C.audioModeVersion);this.C.videoModeVersion&&f.push(this.C.videoModeVersion);this.C.userDetails&&
f.push(this.C.userDetails);this.C.details&&f.push(this.C.details);this.C.albumRelease&&f.push(this.C.albumRelease);this.C.share&&f.push(this.C.share);this.C.libraryEdit&&f.push(this.C.libraryEdit);this.C.downloadMetadata&&f.push(this.C.downloadMetadata);this.C.playbackPosition&&f.push(this.C.playbackPosition);this.C.lyrics&&f.push(this.C.lyrics);return[...(new Set(f))]}},musicTrackUserDetail:class extends Bv{G(){const f=[];this.C.parentTrack&&f.push(this.C.parentTrack);return[...(new Set(f))]}},offlineOrchestrationActionWrapperEntity:class extends Bv{G(){return[]}},
offlineVideoPolicy:class extends Bv{G(){return[]}},offlineVideoStreams:class extends Bv{G(){return[]}},offlineabilityEntity:class extends Bv{G(){return[]}},orchestrationWebSamplingEntity:class extends Bv{G(){const f=[];this.C.fakeChildren&&f.push(...this.C.fakeChildren);return[...(new Set(f))]}},pageHeaderEntity:class extends Bv{G(){return[]}},pdpStateEntity:class extends Bv{G(){return[]}},pinnedProductEntity:class extends Bv{G(){return[]}},playbackData:class extends Bv{G(){const f=[];this.C.transfer&&
f.push(this.C.transfer);this.C.adsPlaybackData&&f.push(...this.C.adsPlaybackData);this.C.drmLicense&&f.push(this.C.drmLicense);this.C.offlineVideoPolicy&&f.push(this.C.offlineVideoPolicy);this.C.videoDownloadContextEntity&&f.push(this.C.videoDownloadContextEntity);return[...(new Set(f))]}},playerStateEntity:class extends Bv{G(){return[]}},quantityIncrementerEntity:class extends Bv{G(){return[]}},refresh:class extends Bv{G(){return[]}},saveToPlaylistListEntity:class extends Bv{G(){return[]}},selectedChipIndexEntityPayload:class extends Bv{G(){return[]}},
settingEntity:class extends Bv{G(){return[]}},stringEntity:class extends Bv{G(){return[]}},suggestedFeedbackChipStateEntity:class extends Bv{G(){return[]}},transfer:class extends Bv{G(){const f=[];this.C.offlineVideoStreams&&f.push(...this.C.offlineVideoStreams);this.C.captionTrack&&f.push(...this.C.captionTrack);return[...(new Set(f))]}},trendingOfferEntity:class extends Bv{G(){return[]}},videoDownloadContextEntity:class extends Bv{G(){return[]}},videoOverviewAsyncDataEntity:class extends Bv{G(){return[]}},
videoPlaybackPositionEntity:class extends Bv{G(){return[]}},votingEntity:class extends Bv{G(){return[]}},ytMainChannelEntity:class extends Bv{G(){const f=[];this.C.userChannelDetails&&f.push(this.C.userChannelDetails);return[...(new Set(f))]}},youchatPendingResponseEntity:class extends Bv{G(){return[]}},ytMainDownloadedVideoEntity:class extends Bv{G(){const f=[];this.C.video&&f.push(this.C.video);this.C.playbackData&&f.push(this.C.playbackData);this.C.offlineVideoPolicy&&f.push(this.C.offlineVideoPolicy);
return[...(new Set(f))]}},ytMainVideoEntity:class extends Bv{G(){const f=[];this.C.channelOwner&&f.push(this.C.channelOwner);this.C.playbackPosition&&f.push(this.C.playbackPosition);this.C.localImageEntities&&f.push(...this.C.localImageEntities);this.C.downloadStatus&&f.push(this.C.downloadStatus);return[...(new Set(f))]}}},$ZI=class{constructor(f,e){this.C=f;this.G=e;this.J={}}},aeG=class extends qzG{J(f){return f}G(f){if(f instanceof Uint8Array)throw new a9("WRONG_DATA_TYPE",{hT:0});return f}},
eBF=class{constructor(){this.C={};this.C[0]=new aeG;if(!g.UV("aes_pes_encoder_killswitch")){var f=this.C;try{const n=g.Ho();var e=po(n);var B=new zCM(new g.T8(e),new g.QZ(e))}catch(n){throw f=n instanceof Error?new a9("KEY_CREATION_FAILED",{originalMessage:n.message}):new a9("KEY_CREATION_FAILED"),g.J(f),f;}f[1]=B}}},BjB=class extends g.$0{constructor(f,e){super();this.token=f;this.C=e;this.observers=[];f=new g.Kw.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.Ho()}`);f.onmessage=this.G.bind(this);
this.channel=f}observe(f){this.observers.push(f);return()=>{const e=this.observers.indexOf(f);e>=0&&this.observers.splice(e,1)}}G(f){Ixe(this,f.data)}bY(){this.channel.close()}},Sn;var GpL=new g.I("elementsCommand");var q0=new g.I("entityBatchUpdate");var SlI=new g.I("downloadStatusEntity");var oYI=new g.I("mainPlaylistEntityActionMetadata");var Ii=new g.I("mainVideoEntityActionMetadata");var fgB=new g.I("musicPlaylistEntityActionMetadata");var fW=new g.I("musicTrackEntityActionMetadata");var x7F=new g.I("offlineOrchestrationActionCommand");var TpL=new g.I("localImageEntityActionMetadata");var Fr=new g.I("playbackDataActionMetadata");var mST=new g.I("transferEntityActionMetadata");var c8e=new g.I("videoPlaybackPositionEntityActionMetadata");var zBF=class{constructor(){this.C=new Map}},Jx;g.pe("","downloadsPageViewConfigurationEntity");g.pe("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");var zA=g.pe("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","mainDownloadsListEntity");g.pe("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","refresh");g.pe("SMART_DOWNLOADS_ENABLED","settingEntity");new g.rF;new g.rF;var A6g=class{constructor(){this.locks=navigator.locks}request(f,e={},B){return this.locks.request(f,e,n=>B(n))}};var xo=g.Kw.caches,GQ,W3,pTG=class{open(f){return xo.open(Mt(f))}has(f){return xo.has(Mt(f))}delete(f){return xo.delete(Mt(f))}async match(f,e){var B=await this.keys();for(const n of B)if(B=await (await this.open(n)).match(f,e))return B}},o1g=class extends pTG{async keys(){const f=[],e=g.Ho("CacheStorage keys");var B=await xo.keys();for(const n of B){B=n.indexOf(":");const {N1:r,datasyncId:L}=B===-1?{N1:n}:{N1:n.substring(0,B),datasyncId:n.substring(B+1)};L===e&&f.push(r)}return f}};var cDM=class extends g.$0{constructor(f){super();this.api=f;this.aX={zxY:()=>this.C,
PjI:()=>this.G};
typeof g.Kw.BroadcastChannel!=="undefined"&&(this.C=new g.Kw.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.Ho()}`),this.C.onmessage=this.J.bind(this),this.G=new g.Kw.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.Ho()}`),this.G.onmessage=this.V.bind(this))}J(f){g.yW(this.api,"onOfflineOperationFailure",f.data)}V(f){this.api.publish("offlinetransferpause",f.data)}bY(){this.C?.close();this.G?.close()}};var YzT=class{constructor(f,e,B){this.K=f;this.N=e;this.visibility=B;this.W=this.X=this.U=this.J=this.C=!1;this.V=new g.T6(()=>{this.KI()});
this.aX={LJ:()=>this.G,
KI:()=>{this.KI()},
H5Y:()=>this.V};
this.visibility.subscribe("visibilitystatechange",()=>{this.p5()})}p5(){this.C&&yi(this)}KI(){this.G&&this.G.resolve();
this.J=this.C=!1;this.N()}};var XUe=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var kS=class{constructor(f,e,B,n,r=e,L,d,t,H,k,C){this.entityType=f;this.actionId=e;this.action=B;this.parentActionId=n;this.rootActionId=r;this.childActionIds=L;this.prereqActionId=d;this.postreqActionIds=t;this.hasChildActionFailed=k;this.retryScheduleIndex=0;this.C=C||Date.now();this.retryScheduleIndex=H||0}};var J62="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var I32="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var nW=class{constructor(f){this.C=f}},U9=class{constructor(f,e,B,n,r,L){this.status=f;this.C=e;this.V=B;this.G=n;this.J=r;this.downloadState=L}};var ADx=class extends nW{constructor(f,e,B){super(f);this.C=f;this.Ta=e;this.J=B}G(f){return i3(f)?K2B(this,f):fc(f)?age(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}};var jIg=class extends nW{constructor(f,e){super(f);this.C=f;this.Ta=e}G(f){return fc(f)?pUg(this,f):g1V(f)?Yig(this,f):e0(f)?A8B(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}};var OYg=class{constructor(f,e){this.api=f;this.C=e;this.logger=new g.or("woffle");this.G=!1;this.aX={TO:this.TO}}async V(f){if(f.state.C(128)){const e=f.state.iE;f=e?.errorCode;f=f==="net.connect"&&e?.Fa===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":f?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Kk(this.player.getVideoData().videoId,f)}}async Kk(f,e){this.G||(this.G=!0,e==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?S0(this,f,!1,!0):(await g3(this,f),
g.Qm(f,4),await this.C.Kk(e)))}ww(f){f.status===2?(f.status!==this.J&&(WC(this.C),g.Qm(f.videoId,2)),f.us&&rRu(this.C,f.videoId,f.us)):f.status===4?(g3(this,f.videoId),this.Kk(f.videoId,f.Sd?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):f.status===1&&dne(this.C);this.J=f.status;g.yW(this.api,"localmediachange",{videoId:f.videoId,status:f.status})}async Pc(){if(!this.G){this.G=!0;var f=this.player.getVideoData().videoId;await g3(this,f);await this.C.Pc()}}TO(f){switch(f){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}Y(f){return this.api.S().Y(f)}};var o0u=class extends nW{constructor(f,e){super(f);this.C=f;this.Ta=e}G(f){return i3(f)?lgL(this,f):fc(f)?u8L(this,f):g1V(f)?F2B(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}};var VIg=class{constructor(){this.actions=[]}C(f,e){let B=f.action.actionMetadata.priority-e.action.actionMetadata.priority;B===0&&(f.C<e.C?B=-1:f.C>e.C&&(B=1));return B}};var Elu=class extends g.$0{constructor(f,e,B,n,r){super();this.G=f;this.Cq=e;this.Ed=B;this.X=n;this.Ta=r;this.C=new VIg;this.U=new g.v0;this.J=new g.T6(()=>{this.retry()});
this.K=NaN;this.W=!1;this.aX={Z5A:()=>this.C,
PK:()=>this.U,
XsC:()=>this.J,
retry:()=>this.retry()};
g.A(this,this.J);this.N=this.G.observe(this.A.bind(this))}bY(){this.N&&this.N();super.bY()}createAction(f,e){const B=g.aJ(f.entityKey).entityType,n=g.HR(16);return new kS(B,n,f,e.actionId,e.rootActionId)}async A(f){if(!this.HS()){var e=f.offlineOrchestrationActionWrapperEntity??new Set;f=[];for(var B of e)({entityId:e}=g.aJ(B)),SiG(this.C,e)||f.push(B);B=await W2M(this,f);await TA(this,B)}}async retry(){await Phg(this)}};var lee=class{constructor(f){this.wi=f;this.C=void 0}async xf(f,e=!0){if(this.C){var B=[],n=g.BO(this.C.C,e),r=[];for(let L=0;L<n.length;L++)e=this.C.U(n[L],"json3"),e=g.sV(e,{withCredentials:!0,format:"RAW"},3,500).then(d=>{d={metadata:g.ap(n[L]),trackData:d.xhr.responseText};r.push(d)}).wT(d=>{Qi("Caption fetch error",d)}),B.push(e);
await g6B(B);try{await v1e(f,r)}catch(L){Qi("Caption DB transaction error",L)}}}};var uP2=class extends g.$0{constructor(f){super();this.C=f;this.G=this.C.observe(this.J.bind(this))}bY(){this.G&&this.G();super.bY()}async J(f){var e=f.transfer??new Set;f=[];for(const B of e)({entityId:e}=g.aJ(B)),f.push(e);f.length!==0&&await itH(this,f)}};var z7B=class extends g.$0{constructor(f,e,B,n){super();this.G=f;this.api=e;this.uY=B;this.A=n;this.U=new g.v0;this.V=new g.T6(()=>{this.C&&this.C.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.U.rZ()&&((this.C.transferRetryCount||0)<3?S0(this.X,this.W,!1,!1):g3(this.X,this.W.videoDetails.videoId),this.Kk("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.Ed=this.eI=0;this.N=this.K=!1;this.BS=g.tS(this.api.S().experiments,"html5_transfer_processing_logs_interval");this.Lq=new g.ep(this);this.aX={kvj:()=>this.V,
Wkq:()=>this.A,
PK:()=>this.U};
this.Cq=this.G.observe(this.Z9.bind(this));this.X=new OYg(e,this);this.Fl=new lee(e);this.cS=new uP2(this.G);this.PS=this.U.listen("publicytnetworkstatus-online",this.YW.bind(this));this.WS=this.U.listen("publicytnetworkstatus-offline",this.MC.bind(this));this.N=this.api.S().Y("html5_less_transfer_processing_logs");g.A(this,this.Lq);this.Lq.D(e,"offlinetransferpause",this.kA);if(g.yQ(this.api.S()))this.J="mainVideoDownloadStateEntity";else if(g.TT(this.api.S())||g.rC(this.api.S()))this.J="musicTrackDownloadMetadataEntity"}bY(){this.Cq&&
this.Cq();this.cS.dispose();this.V.dispose();this.PS&&g.dK(this.U.h0,this.PS);this.WS&&g.dK(this.U.h0,this.WS);super.bY()}async kA(f){const e=g.pe(f,"transfer");if(this.C&&e===this.C.key)S0(this.X,this.W,!0),this.V.stop();else{const B=await mp(this.G,{mode:"readwrite",XG:!0},n=>Ax(n,e,"transfer").then(r=>{if(r&&r.transferState!=="TRANSFER_STATE_COMPLETE"&&r.transferState!=="TRANSFER_STATE_FAILED")return r.transferState="TRANSFER_STATE_PAUSED_BY_USER",Vi(n,r,"transfer").then(()=>r)}));
if(B){f&&this.J&&await BC(f,this.J,this.G,"DOWNLOAD_STATE_PAUSED");const n=await Jy(this,f);NjF({videoId:f,RJ:B,offlineModeType:n})}}}MC(){if(this.C&&this.W){S0(this.X,this.W,!1);const f=this.C,e=f?.key?g.aJ(f.key).entityId:"";e&&this.J&&(new Promise((B,n)=>{BC(e,this.J,this.G,"DOWNLOAD_STATE_PAUSED").catch(r=>{n(r)})})).catch(B=>{Qi("Download state setting error",B)})}this.V.stop()}YW(){this.C?bOx(this,this.C):xS(this)}async Z9(f){if(this.C&&(this.C.transferState!=="TRANSFER_STATE_COMPLETE"&&this.C.transferState!==
"TRANSFER_STATE_FAILED"&&f.transfer&&f.transfer.has(this.C.key)&&((this.C=await hx(this.G,this.C.key,"transfer"))||await ZOV(this)),this.C))return;
await xS(this)}async Kk(f,e){if(this.C){var B=this.C;const r=B?.key?g.aJ(B.key).entityId:"";a:switch(f){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var n=!1;break a;default:n=!0}n&&R7B(this)?(await Dn(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),f=await Jy(this,r),I9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:r,RJ:B,offlineModeType:f}),
r&&this.J&&await BC(r,this.J,this.G,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await KDV(this,f),r&&this.J&&await BC(r,this.J,this.G,"DOWNLOAD_STATE_FAILED"))}else M0(this,`onTransferFailure: ${f}`);GA(this);B=xS(this,!0);e&&e(B)}async Pc(f){if(this.C)if(R7B(this)){await Dn(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.C||M0(this,"onMaybeTransferStreamsExpiredRetryAttempting");var e=this.C,B=e?.key?g.aJ(e.key).entityId:"",n=await Jy(this,B);I9({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:B,RJ:e,offlineModeType:n});e=HC();g.mj(e,Fr,{isEnqueuedForExpiredStreamUrlRefetch:!0});n=g.pe(B,"playbackData");B=w3(new kS("playbackData",B,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:n,actionMetadata:e}));await UJ(this.G,B,"offlineOrchestrationActionWrapperEntity")}else await KDV(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.J&&(B=this.C,(B=B?.key?g.aJ(B.key).entityId:"")&&await BC(B,this.J,this.G,"DOWNLOAD_STATE_FAILED"));else M0(this,"onMaybeTransferStreamsExpired");
GA(this);B=xS(this,!0);f&&f(B)}},s9={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var FbL=class{constructor(f,e){this.Ta=f;this.api=e;this.X=new g.v0;this.W=new g.rF;this.aX={LJ:()=>this.J.aX.LJ(),
PK:()=>this.X,
LkA:()=>this.J,
Ex:()=>this.Ex(),
vO:()=>this.vO(),
pE:()=>this.pE(),
KP:()=>this.KP(),
BI:()=>this.BI(),
PU:B=>this.PU(B)};
this.J=new YzT(()=>qOT(this),()=>{this.pE()},this.api.lE(),this.api.Y.bind(this.api));
this.C=new cDM(this.api);l3e(this.J)}Ex(){return this.W.promise}vO(){if(this.G&&this.K)return this.W.promise;pX2(this).then(this.W.resolve).catch(this.W.reject);return this.W.promise}U(f){return{playbackData:new ADx(f,this.Ta,this.C),transfer:new o0u(f,this.Ta),videoPlaybackPositionEntity:new jIg(f,this.Ta)}}async KP(){this.G&&await tvu(this.G)}async pE(){if(this.G||this.K)await this.Ex(),this.Ed!==void 0&&(g.Fx(this.Ed),this.Ed=void 0),this.V!==void 0&&(g.Fx(this.V),this.V=void 0),this.G?.dispose(),
this.G=void 0,this.K?.dispose(),this.K=void 0,g.yW(this.api,"onOrchestrationLostLeader"),this.W=new g.rF}isOrchestrationLeader(){return this.J.C}async cS(){return!1}jP(f){var e=this.C;e.api.publish("offlinetransferpause",f);e.G?.postMessage(f)}async YW(f){const e=await EJ();if(e){var B=g.pe(f,"transfer");await mp(e,{mode:"readwrite",XG:!0},n=>{const r=Ax(n,B,"transfer"),L=Ax(n,g.pe(f,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.FD.all([r,L]).then(([d,t])=>d&&d.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(d.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",Vi(n,d,"transfer").then(()=>{I9({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:f,RJ:d,offlineModeType:t?.offlineModeType});return g.FD.resolve(null)})):g.FD.resolve(null))})}}async Cq(f=43200){if(!this.X.rZ())return cRL();
var e=await EJ();if(!e)return[];const B=Date.now()/1E3;var n=await gm(e,"offlineVideoPolicy");e=[];for(const r of n)Number(r.lastUpdatedTimestampSeconds)+f<=B&&(n=g.aJ(r.key).entityId,e.push(n));return e.length?Xr(this,e,this.A,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return Xr(this,["!*$_ALL_ENTITIES_!*$"],this.A,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(f){return await this.Cq(f)}setUpPositionSyncInterval(f){this.V!==
void 0&&(g.Fx(this.V),this.V=void 0);const e=f??864E5;this.V=g.ls(()=>{this.PU(e)},e)}async PU(f){try{const e=await N0.getInstance();
if(!e)throw Error("prefStorage is undefined");const B=await e.get("psi"),n=B?.XU?Number(B.XU)/1E3:0,r=Date.now();n+f<=r&&await Xr(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(e){Qi("Offline manager error",e)}}async BI(){var f=await EJ();if(!f)return[];var e=await gm(f,"transfer");f=[];for(const B of e)B.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&B.key&&(e=g.aJ(B.key).entityId,f.push(e));return ARI(this,f)}async N(){return[]}async WS(){}async eI(){}};var mfe=class extends nW{constructor(f,e,B){super(f);this.C=f;this.Ta=e;this.J=B}G(f){return i3(f)?OOF(this,f):fc(f)?VvF(this,f):e0(f)?ldL(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}},yu=[10];var UfB=class extends nW{constructor(f,e,B){super(f);this.C=f;this.Ta=e;this.J=B}G(f){return i3(f)?gYB(this,f):fc(f)?SOe(this,f):e0(f)?EYV(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}},h7e=[10];var Nee=class extends nW{constructor(f,e,B){super(f);this.C=f;this.Ta=e;this.J=B}G(f){return fc(f)?DnI(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}};var hCH=class extends FbL{constructor(){super(...arguments);this.A="mainVideoEntity"}U(f){const e=super.U(f);e.mainVideoEntity=new UfB(f,this.Ta,this.C);e.mainPlaylistEntity=new mfe(f,this.Ta,this.C);e.mainDownloadsListEntity=new Nee(f,this.Ta,this.C);return e}async refreshAllStaleEntities(f,e){let B=[];this.Ta.Y("web_player_offline_playlist_auto_refresh")&&(B=await JRV(this,f,e));var n=await N0.getInstance();const r=await n?.get("sdois");n=await n?.get("lmqf");r&&(B=B.concat(await Mve(this,r,n??
"SD",f===0)));return B=B.concat(await super.refreshAllStaleEntities(f,e))}async cS(f){var e=await EJ();if(!e)return!1;e=await hx(e,zA,"mainDownloadsListEntity");if(e?.downloads?.length){f=g.pe(f,"mainVideoEntity");for(const B of e.downloads)if(B.videoItem===f)return!0}return!1}async N(){var f=await EJ();if(!f)return[];var e=await gm(f,"downloadStatusEntity");f=[];for(const B of e)B.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&B.key&&(e=g.aJ(B.key).entityId,f.push(e));return f.length?Xr(this,f,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async eI(){const f=await EJ();f&&await mp(f,{mode:"readwrite",XG:!0},e=>jn(e,"mainVideoEntity").then(B=>{const n=[];for(const r of B){if(r.userState?.playbackPosition)continue;B=g.aJ(r.key).entityId;B={key:g.pe(B,"videoPlaybackPositionEntity"),videoId:B,lastPlaybackPositionSeconds:"0"};n.push(Vi(e,B,"videoPlaybackPositionEntity"));r.userState={playbackPosition:B.key};n.push(Vi(e,
r,"mainVideoEntity"))}return g.FD.all(n)}))}async WS(){const f=await EJ();
if(f){var e=g.pe("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),B=await mp(f,{mode:"readonly",XG:!0},w=>g.FD.all([Ax(w,e,"mainDownloadsListEntity"),Ax(w,zA,"mainDownloadsListEntity"),jn(w,"mainVideoEntity"),jn(w,"mainPlaylistEntity")])),[n,
r,L,d]=B;B=new Set;if(n?.downloads?.length)for(var t of n.downloads){var H=t.videoItem??t.playlistItem;H&&B.add(H)}if(r?.downloads?.length)for(var k of r.downloads)k.videoItem&&B.add(k.videoItem);t=new Set;k=[];for(var C of d){if(C.videos)for(const w of C.videos)(H=JSON.parse(g.aJ(w).entityId).videoId)&&t.add(H);C.key&&!B.has(C.key)&&k.push(C.key)}for(const w of L)w.key&&!B.has(w.key)&&(C=g.aJ(w.key).entityId,t.has(C)||k.push(w.key));k.length&&await ai(f,k)}}};var g0G=class extends nW{constructor(f,e){super(f);this.C=f;this.J=e}G(f){return i3(f)?xng(this,f):fc(f)?WDx(this,f):e0(f)?s12(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}},$S=[10];var SzI=class extends nW{constructor(f,e){super(f);this.C=f;this.J=e}G(f){return i3(f)?PTH(this,f):fc(f)?Ide(this,f):e0(f)?$nL(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}},i9=[10];var E0G=class extends nW{constructor(f,e){super(f);this.C=f;this.J=e}G(f){return i3(f)?n0H(this,f):fc(f)?rDB(this,f):e0(f)?LbM(this,f):Promise.reject(Error(`Unsupported action type: ${f.actionType}`))}},Bee=[10];var QIe=class extends FbL{constructor(){super(...arguments);this.A="musicTrack"}U(f){const e=super.U(f);e.musicTrack=new E0G(f,this.C);e.musicPlaylist=new SzI(f,this.C);e.musicAlbumRelease=new g0G(f,this.C);return e}async refreshAllStaleEntities(f,e){let B=await tIF(this,f,e);return B=B.concat(await super.refreshAllStaleEntities(f,e))}};g.cO("offline",class extends g.zV{constructor(){super(...arguments);this.events=new g.ep(this);this.Ta=this.player.S();this.aX={psi:()=>this.C,
YD:()=>this.YD(),
Mf:f=>this.Mf(f)}}create(){g.A(this,this.events);
if(g.yQ(this.Ta))this.C=new hCH(this.Ta,this.player);else if(g.TT(this.Ta)||g.rC(this.Ta))this.C=new QIe(this.Ta,this.player);this.events.D(this.player,"onPlaybackStartExternal",()=>{this.YD()});
this.events.D(this.player,"videodatachange",()=>{this.YD()});
this.Ta.Y("html5_offline_playback_position_sync")&&this.events.D(this.player,"presentingplayerstatechange",this.Mf)}Ls(){return!1}async td(f,e,B,n){return this.C?Xr(this.C,f,e,B,n):Promise.reject()}deleteAll(){return this.C.deleteAll()}Cq(f){return this.C.Cq(f)}refreshAllStaleEntities(f){return this.C.refreshAllStaleEntities(f)}setUpPositionSyncInterval(f){this.C.setUpPositionSyncInterval(f)}jP(f){this.C.jP(f)}YW(f){return this.C.YW(f)}async YD(){const f=this.player.getVideoData();f.Q3()&&HYH(f)&&
this.G!==f.clientPlaybackNonce&&await kDT(this,f)}async Mf(f){var e=this.player.getVideoData();const B=e.G6;if(f.IC(2)||f.IC(512))(f=await EJ())?(e=e.videoId,await hx(f,g.pe(e,"mainVideoEntity"),"mainVideoEntity")&&await this.td([e],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(B).toString()}})):Qi("PES is undefined")}isOrchestrationLeader(){return this.C.isOrchestrationLeader()}async updateDownloadState(f,
e){const B=await EJ();if(B){var {entityType:n,entityId:r}=g.aJ(f);await BC(r,n,B,e,!0)}else Qi("PES is undefined")}});})(_yt_player);
